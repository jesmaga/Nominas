<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aplicación de Gestión de Nóminas</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <script>
        // Comprobación de sesión al cargar la página principal
        if (sessionStorage.getItem('isLoggedIn') !== 'true') {
            // Si no hay señal de sesión, redirige a login.html
            window.location.replace('login.html');
        }
    </script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #111827;
            color: #d1d5db;
        }

        .sidebar-icon {
            stroke-width: 1.5;
        }

        .form-input {
            background-color: #374151;
            border: 1px solid #4b5563;
            color: #d1d5db;
            border-radius: 0.5rem;
        }

        .form-input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 2px #1e40af;
        }

        .btn {
            border-radius: 0.5rem;
            padding: 0.75rem 1.5rem;
            font-weight: 600;
            transition: all 0.2s ease-in-out;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .btn-primary {
            background-color: #2563eb;
            color: white;
        }

        .btn-primary:hover {
            background-color: #1d4ed8;
        }

        .btn-danger {
            background-color: #dc2626;
            color: white;
        }

        .btn-danger:hover {
            background-color: #b91c1c;
        }

        .btn-secondary {
            background-color: #4b5563;
            color: white;
        }

        .btn-secondary:hover {
            background-color: #6b7280;
        }

        .content-card {
            background-color: #1f2937;
            border-radius: 0.75rem;
            padding: 2rem;
            border: 1px solid #374151;
        }

        /* Ocultar secciones por defecto */
        .page-content {
            display: none;
        }

        .page-content.active {
            display: block;
        }

        /* */
        .admin-tab-content {
            display: none;
        }

        .admin-tab-content.active {
            display: block;
        }

        .tab-button.active {
            background-color: #2563eb;
            color: white;
        }

        .data-table th,
        .data-table td {
            padding: 1rem;
            text-align: left;
        }

        .data-table thead {
            border-bottom: 1px solid #4b5563;
        }

        .data-table tbody tr:not(:last-child) {
            border-bottom: 1px solid #374151;
        }

        .nomina-result-grid {
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 0.5rem 1.5rem;
        }

        .nomina-result-grid dt {
            font-weight: 500;
            color: #9ca3af;
        }

        .nomina-result-grid dd {
            text-align: right;
            font-weight: 600;
            color: #e5e7eb;
        }

        #loading-screen {
            position: fixed;
            inset: 0;
            background-color: #111827;
            z-index: 100;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: opacity 0.5s ease-out;
        }

        #app-container.hidden {
            display: none;
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
    <script src="sello.js"></script>
    <script src="pdfGenerator.js" defer></script>
</head>

<body class="flex h-screen">
    <div id="loading-screen">
        <img src="Logo2.png" alt="Cargando..." class="h-24 animate-pulse">
    </div>
    <div id="app-container" class="hidden h-screen flex"></div>
    <aside class="w-64 bg-gray-900 p-6 flex flex-col justify-between">
        <div>
            <div class="mb-10 flex justify-center">
                <img src="Logo2.png" alt="Logo de la Empresa" class="h-13">
            </div>
            <nav class="flex flex-col space-y-2">
                <a href="#puestos"
                    class="nav-link flex items-center space-x-3 p-3 rounded-lg hover:bg-gray-700 text-gray-300 transition-colors duration-200"
                    data-target="puestos">
                    <i data-lucide="briefcase" class="sidebar-icon"></i>
                    <span>Puestos de Trabajo</span>
                </a>
                <a href="#empleados"
                    class="nav-link flex items-center space-x-3 p-3 rounded-lg hover:bg-gray-700 text-gray-300 transition-colors duration-200"
                    data-target="empleados">
                    <i data-lucide="users" class="sidebar-icon"></i>
                    <span>Empleados</span>
                </a>
                -->
                <a href="#admin"
                    class="nav-link flex items-center space-x-3 p-3 rounded-lg hover:bg-gray-700 text-gray-300 transition-colors duration-200"
                    data-target="admin">
                    <i data-lucide="sliders-horizontal" class="sidebar-icon"></i>
                    <span>Admin</span>
                </a>
                <a href="#nominas"
                    class="nav-link flex items-center space-x-3 p-3 rounded-lg hover:bg-gray-700 text-gray-300 transition-colors duration-200"
                    data-target="nominas">
                    <i data-lucide="file-text" class="sidebar-icon"></i>
                    <span>Generar Nóminas</span>
                </a>
                <a href="#nominas-lote"
                    class="nav-link flex items-center space-x-3 p-3 rounded-lg hover:bg-gray-700 text-gray-300 transition-colors duration-200"
                    data-target="nominas-lote">
                    <i data-lucide="layers" class="sidebar-icon"></i>
                    <span>Nóminas por Lote</span>
                </a>
                <a href="#historial-page"
                    class="nav-link flex items-center space-x-3 p-3 rounded-lg hover:bg-gray-700 text-gray-300 transition-colors duration-200"
                    data-target="historial-page">
                    <i data-lucide="history" class="sidebar-icon"></i>
                    <span>Historial</span>
                </a>
            </nav>
            <div class="mt-auto pt-4 border-t border-gray-700"> <button id="logout-button"
                    class="flex items-center space-x-3 p-3 rounded-lg hover:bg-red-700 text-gray-300 transition-colors duration-200 w-full text-left">
                    <i data-lucide="log-out" class="sidebar-icon"></i>
                    <span>Cerrar Sesión</span>
                </button>
            </div>
        </div>
        <div>
        </div>
        <div>
            <div class="py-4 border-t border-gray-700 space-y-2">
                <button id="exportar-datos"
                    class="flex items-center space-x-3 p-3 rounded-lg hover:bg-gray-700 text-gray-300 transition-colors duration-200 w-full text-left">
                    <i data-lucide="download" class="sidebar-icon"></i>
                    <span>Exportar Datos</span>
                </button>
                <button id="importar-datos"
                    class="flex items-center space-x-3 p-3 rounded-lg hover:bg-gray-700 text-gray-300 transition-colors duration-200 w-full text-left">
                    <i data-lucide="upload" class="sidebar-icon"></i>
                    <span>Importar Datos</span>
                </button>
            </div>
            <div class="text-xs text-gray-500 pt-4 border-t border-gray-700">
                <p>&copy; 2025 App de Nóminas</p>
            </div>
        </div>
    </aside>

    <main class="flex-1 p-8 overflow-y-auto">
        <div id="puestos" class="page-content">
            <h2 class="text-3xl font-bold text-white mb-6">Gestión de Puestos de Trabajo</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                <div class="md:col-span-1 content-card">
                    <h3 id="form-puesto-titulo" class="text-xl font-semibold text-white mb-4">Crear Nuevo Puesto</h3>
                    <form id="form-puesto" class="space-y-4">
                        <input type="hidden" id="puesto-id">
                        <div>
                            <label for="puesto-nombre" class="block mb-1 text-sm font-medium">Nombre del Puesto</label>
                            <input type="text" id="puesto-nombre" class="w-full form-input p-2" required>
                        </div>
                        <div>
                            <label for="puesto-salario" class="block mb-1 text-sm font-medium">Salario Base Mensual
                                (€)</label>
                            <input type="number" step="0.01" id="puesto-salario" class="w-full form-input p-2" required>
                        </div>
                        <div>
                            <label for="puesto-horas" class="block mb-1 text-sm font-medium">Horas Estándar
                                Semana</label>
                            <input type="number" step="0.1" id="puesto-horas" class="w-full form-input p-2" required>
                        </div>

                        <fieldset class="border border-gray-600 p-4 rounded-lg">
                            <legend class="text-sm font-medium px-2">Conceptos Salariales por Antigüedad</legend>
                            <div id="conceptos-adicionales-container" class="space-y-2 mb-4">
                            </div>
                            <div class="space-y-3 bg-gray-800 p-3 rounded-md">
                                <h4 class="text-sm font-medium text-gray-300">Añadir Nuevo Concepto</h4>
                                <input type="text" id="new-concepto-nombre"
                                    placeholder="Nombre (Ej: Antigüedad, Quinquenio)"
                                    class="w-full form-input p-2 text-sm">
                                <div class="flex space-x-2">
                                    <input type="number" step="0.01" id="new-concepto-importe" placeholder="Importe (€)"
                                        class="w-1/2 form-input p-2 text-sm">
                                    <input type="number" step="1" id="new-concepto-periodicidad"
                                        placeholder="Cada X años" class="w-1/2 form-input p-2 text-sm">
                                </div>
                                <button type="button" id="btn-add-concepto-puesto"
                                    class="w-full btn btn-secondary btn-sm py-1.5">Añadir Concepto al Puesto</button>
                            </div>
                        </fieldset>

                        <div class="flex space-x-2 pt-2">
                            <button type="submit" class="btn btn-primary w-full">Guardar Puesto</button>
                            <button type="button" id="cancelar-edicion-puesto"
                                class="btn btn-secondary w-full hidden">Cancelar</button>
                        </div>
                    </form>
                </div>
                <div class="md:col-span-2 content-card">
                    <h3 class="text-xl font-semibold text-white mb-4">Puestos Existentes</h3>
                    <div class="overflow-x-auto">
                        <table id="lista-puestos" class="w-full data-table">
                            <thead>
                                <tr>
                                    <th>Nombre</th>
                                    <th>Salario</th>
                                    <th>Horas/Semana</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div id="empleados" class="page-content">
            <h2 class="text-3xl font-bold text-white mb-6">Gestión de Empleados</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                <div class="md:col-span-1 content-card">
                    <h3 id="form-empleado-titulo" class="text-xl font-semibold text-white mb-4">Añadir Nuevo Empleado
                    </h3>
                    <form id="form-empleado" class="space-y-4">
                        <input type="hidden" id="empleado-id">
                        <div>
                            <label for="empleado-nombre" class="block mb-1 text-sm font-medium">Nombre</label>
                            <input type="text" id="empleado-nombre" class="w-full form-input p-2" required>
                        </div>
                        <div>
                            <label for="empleado-puesto" class="block mb-1 text-sm font-medium">Puesto</label>
                            <select id="empleado-puesto" class="w-full form-input p-2" required>
                            </select>
                        </div>
                        <div>
                            <label for="empleado-horas" class="block mb-1 text-sm font-medium">Horas Contrato
                                Semanales</label>
                            <input type="number" id="empleado-horas" class="w-full form-input p-2" required>
                        </div>
                        <div>
                            <label for="empleado-tipo-contrato" class="block mb-1 text-sm font-medium">Tipo de
                                Contrato</label>
                            <select id="empleado-tipo-contrato" class="w-full form-input p-2" required>
                                <option value="">-- Selecciona un tipo --</option>
                            </select>
                        </div>
                        <div>
                            <label for="empleado-dni" class="block mb-1 text-sm font-medium">DNI</label>
                            <input type="text" id="empleado-dni" class="w-full form-input p-2" required>
                        </div>
                        <div>
                            <label for="empleado-ss" class="block mb-1 text-sm font-medium">Número SS</label>
                            <input type="text" id="empleado-ss" class="w-full form-input p-2" required>
                        </div>
                        <div>
                            <label for="empleado-antiguedad" class="block mb-1 text-sm font-medium">Fecha
                                Antigüedad</label>
                            <input type="date" id="empleado-antiguedad" class="w-full form-input p-2" required>
                        </div>
                        <div>
                            <label for="empleado-cotizacion" class="block mb-1 text-sm font-medium">Grupo de
                                Cotización</label>
                            <input type="text" id="empleado-cotizacion" class="w-full form-input p-2" required>
                        </div>

                        <!-- SECCIÓN DATOS FISCALES (MODELO 145) -->
                        <div class="border-t border-gray-700 pt-4 mt-4">
                            <h4 class="text-lg font-semibold text-white mb-3">Datos Fiscales (Modelo 145)</h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label for="empleado-estado-civil" class="block mb-1 text-sm font-medium">Estado
                                        Civil</label>
                                    <select id="empleado-estado-civil" class="w-full form-input p-2">
                                        <option value="soltero">Soltero/a / Divorciado/a</option>
                                        <option value="casado">Casado/a (y no separado/a)</option>
                                        <option value="viudo">Viudo/a</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="empleado-anio-nacimiento" class="block mb-1 text-sm font-medium">Año de
                                        Nacimiento</label>
                                    <input type="number" id="empleado-anio-nacimiento" class="w-full form-input p-2"
                                        placeholder="Ej: 1985">
                                </div>
                                <div>
                                    <label for="empleado-discapacidad" class="block mb-1 text-sm font-medium">Grado de
                                        Discapacidad</label>
                                    <select id="empleado-discapacidad" class="w-full form-input p-2">
                                        <option value="0">Sin discapacidad (< 33%)</option>
                                        <option value="33">>= 33% y < 65%</option>
                                        <option value="65">>= 65%</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="empleado-hijos" class="block mb-1 text-sm font-medium">Hijos (< 25
                                            años)</label>
                                            <input type="number" id="empleado-hijos" class="w-full form-input p-2"
                                                value="0" min="0">
                                </div>
                                <div>
                                    <label for="empleado-ascendientes"
                                        class="block mb-1 text-sm font-medium">Ascendientes (> 65 años)</label>
                                    <input type="number" id="empleado-ascendientes" class="w-full form-input p-2"
                                        value="0" min="0">
                                </div>
                            </div>
                        </div>
                        <div class="flex space-x-2 pt-2">
                            <button type="submit" class="btn btn-primary w-full">Guardar Empleado</button>
                            <button type="button" id="cancelar-edicion-empleado"
                                class="btn btn-secondary w-full hidden">Cancelar</button>
                        </div>
                    </form>
                </div>
                <div class="md:col-span-2 content-card">
                    <h3 class="text-xl font-semibold text-white mb-4">Lista de Empleados</h3>
                    <div class="overflow-x-auto">
                        <table id="lista-empleados" class="w-full data-table">
                            <thead>
                                <tr>
                                    <th>Nombre</th>
                                    <th>Puesto</th>
                                    <th>Tipo de Contrato</th>
                                    <th>DNI</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>



        <div id="admin" class="page-content">
            <h2 class="text-3xl font-bold text-white mb-6">Administración</h2>

            <div class="mb-6 border-b border-gray-700">
                <nav class="flex space-x-4" aria-label="Tabs">
                    <button
                        class="tab-button active py-2 px-4 text-sm font-medium text-gray-300 rounded-t-lg hover:bg-gray-700"
                        data-target="admin-ss">
                        Configuración SS
                    </button>
                    <button
                        class="tab-button py-2 px-4 text-sm font-medium text-gray-300 rounded-t-lg hover:bg-gray-700"
                        data-target="admin-conceptos">
                        Conceptos de Nómina
                    </button>
                    <button
                        class="tab-button py-2 px-4 text-sm font-medium text-gray-300 rounded-t-lg hover:bg-gray-700"
                        data-target="admin-empresa">
                        Datos de Empresa
                    </button>
                    <button
                        class="tab-button py-2 px-4 text-sm font-medium text-gray-300 rounded-t-lg hover:bg-gray-700"
                        data-target="admin-contratos">
                        Tipos de Contrato
                    </button>
                    <button id="tab-admin-usuarios"
                        class="tab-button py-2 px-4 text-sm font-medium text-gray-300 rounded-t-lg hover:bg-gray-700 hidden"
                        data-target="admin-usuarios">
                        Gestionar Usuarios
                    </button>
                    <button
                        class="tab-button py-2 px-4 text-sm font-medium text-gray-300 rounded-t-lg hover:bg-gray-700"
                        data-target="admin-irpf">
                        Tramos IRPF
                    </button>
                </nav>
            </div>

            <div id="admin-ss" class="admin-tab-content active">
                <form id="form-admin" class="content-card max-w-4xl mx-auto">
                    <h3 class="text-2xl font-bold text-white mb-6">Configuración de Cotizaciones de la Seguridad Social
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-x-12 gap-y-6">
                        <div class="space-y-4">
                            <h3 class="text-xl font-semibold text-white">Cotizaciones del Empleado</h3>
                            <div>
                                <label for="ss-cc-empleado" class="block mb-1 text-sm font-medium">Contingencias Comunes
                                    (%)</label>
                                <input type="number" step="0.0001" id="ss-cc-empleado" class="w-full form-input p-2"
                                    required>
                            </div>
                            <div>
                                <label for="ss-desempleo-empleado" class="block mb-1 text-sm font-medium">Desempleo
                                    (%)</label>
                                <input type="number" step="0.0001" id="ss-desempleo-empleado"
                                    class="w-full form-input p-2" required>
                            </div>
                            <div>
                                <label for="ss-fp-empleado" class="block mb-1 text-sm font-medium">Formación Profesional
                                    (%)</label>
                                <input type="number" step="0.0001" id="ss-fp-empleado" class="w-full form-input p-2"
                                    required>
                            </div>
                            <div>
                                <label for="ss-mei-empleado" class="block mb-1 text-sm font-medium">Mecanismo Equidad
                                    Intergeneracional (%)</label>
                                <input type="number" step="0.0001" id="ss-mei-empleado" class="w-full form-input p-2"
                                    required>
                            </div>
                        </div>
                        <div class="space-y-4">
                            <h3 class="text-xl font-semibold text-white">Cotizaciones de la Empresa</h3>
                            <div>
                                <label for="ss-cc-empresa" class="block mb-1 text-sm font-medium">Contingencias Comunes
                                    (%)</label>
                                <input type="number" step="0.0001" id="ss-cc-empresa" class="w-full form-input p-2"
                                    required>
                            </div>
                            <div>
                                <label for="ss-at-ep-empresa" class="block mb-1 text-sm font-medium">Accidentes de
                                    Trabajo y EP (%)</label>
                                <input type="number" step="0.0001" id="ss-at-ep-empresa" class="w-full form-input p-2"
                                    required>
                            </div>
                            <div>
                                <label for="ss-desempleo-ind-gen-empresa"
                                    class="block mb-1 text-sm font-medium">Desempleo (Indefinido General) (%)</label>
                                <input type="number" step="0.0001" id="ss-desempleo-ind-gen-empresa"
                                    class="w-full form-input p-2" required>
                            </div>
                            <div>
                                <label for="ss-desempleo-ind-dis-empresa"
                                    class="block mb-1 text-sm font-medium">Desempleo (Indefinido Discapacidad)
                                    (%)</label>
                                <input type="number" step="0.0001" id="ss-desempleo-ind-dis-empresa"
                                    class="w-full form-input p-2" required>
                            </div>
                            <div>
                                <label for="ss-desempleo-tem-gen-empresa"
                                    class="block mb-1 text-sm font-medium">Desempleo (Temporal General) (%)</label>
                                <input type="number" step="0.0001" id="ss-desempleo-tem-gen-empresa"
                                    class="w-full form-input p-2" required>
                            </div>
                            <div>
                                <label for="ss-desempleo-tem-dis-empresa"
                                    class="block mb-1 text-sm font-medium">Desempleo (Temporal Discapacidad) (%)</label>
                                <input type="number" step="0.0001" id="ss-desempleo-tem-dis-empresa"
                                    class="w-full form-input p-2" required>
                            </div>
                            <div>
                                <label for="ss-fp-empresa" class="block mb-1 text-sm font-medium">Formación Profesional
                                    (%)</label>
                                <input type="number" step="0.0001" id="ss-fp-empresa" class="w-full form-input p-2"
                                    required>
                            </div>
                            <div>
                                <label for="ss-fogasa-empresa" class="block mb-1 text-sm font-medium">FOGASA (%)</label>
                                <input type="number" step="0.0001" id="ss-fogasa-empresa" class="w-full form-input p-2"
                                    required>
                            </div>
                        </div>
                    </div>
                    <div class="mt-8 flex justify-end">
                        <button type="submit" class="btn btn-primary">Guardar Configuración SS</button>
                    </div>
                </form>
            </div>

            <div id="admin-conceptos" class="admin-tab-content">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <div class="content-card">
                        <h3 class="text-xl font-semibold text-white mb-4">Conceptos de Devengo</h3>
                        <form id="form-add-devengo" class="flex space-x-2 mb-4">
                            <input type="text" id="new-devengo-name" placeholder="Nombre del nuevo devengo"
                                class="w-full form-input p-2" required>
                            <button type="submit" class="btn btn-primary whitespace-nowrap">Añadir</button>
                        </form>
                        <ul id="lista-devengos" class="space-y-2">
                        </ul>
                    </div>
                    <div class="content-card">
                        <h3 class="text-xl font-semibold text-white mb-4">Conceptos de Deducción</h3>
                        <form id="form-add-deduccion" class="flex space-x-2 mb-4">
                            <input type="text" id="new-deduccion-name" placeholder="Nombre de la nueva deducción"
                                class="w-full form-input p-2" required>
                            <button type="submit" class="btn btn-primary whitespace-nowrap">Añadir</button>
                        </form>
                        <ul id="lista-deducciones" class="space-y-2">
                        </ul>
                    </div>
                </div>
            </div>
            <div id="admin-empresa" class="admin-tab-content">
                <form id="form-empresa" class="content-card max-w-2xl mx-auto">
                    <h3 class="text-2xl font-bold text-white mb-6">Datos de la Empresa</h3>
                    <div class="space-y-4">
                        <div>
                            <label for="empresa-nombre" class="block mb-1 text-sm font-medium">Nombre de la
                                Empresa</label>
                            <input type="text" id="empresa-nombre" class="w-full form-input p-2" required>
                        </div>
                        <div>
                            <label for="empresa-domicilio" class="block mb-1 text-sm font-medium">Domicilio</label>
                            <input type="text" id="empresa-domicilio" class="w-full form-input p-2" required>
                        </div>
                        <div>
                            <label for="empresa-cif" class="block mb-1 text-sm font-medium">CIF</label>
                            <input type="text" id="empresa-cif" class="w-full form-input p-2" required>
                        </div>
                        <div>
                            <label for="empresa-ccc" class="block mb-1 text-sm font-medium">Código de Cuenta de
                                Cotización (CCC)</label>
                            <input type="text" id="empresa-ccc" class="w-full form-input p-2" required>
                        </div>
                    </div>
                    <div class="mt-8 flex justify-end">
                        <button type="submit" class="btn btn-primary">Guardar Datos</button>
                    </div>
                </form>
            </div>
            <div id="admin-contratos" class="admin-tab-content">
                <div class="content-card max-w-2xl mx-auto">
                    <h3 class="text-2xl font-bold text-white mb-6">Gestionar Tipos de Contrato</h3>
                    <form id="form-add-contrato" class="flex space-x-2 mb-4">
                        <input type="text" id="new-contrato-name" placeholder="Nombre del nuevo tipo de contrato"
                            class="w-full form-input p-2" required>
                        <button type="submit" class="btn btn-primary whitespace-nowrap">Añadir</button>
                    </form>
                    <ul id="lista-contratos" class="space-y-2">
                    </ul>
                </div>
            </div>
            <div id="admin-usuarios" class="admin-tab-content">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <div class="content-card">
                        <h3 class="text-xl font-semibold text-white mb-4">Añadir Nuevo Usuario</h3>
                        <form id="form-add-usuario" class="space-y-4">
                            <div>
                                <label for="new-username" class="block mb-1 text-sm font-medium">Nombre de
                                    Usuario</label>
                                <input type="text" id="new-username" class="w-full form-input p-2" required>
                            </div>
                            <div>
                                <label for="new-password" class="block mb-1 text-sm font-medium">Contraseña</label>
                                <input type="password" id="new-password" class="w-full form-input p-2" required>
                            </div>
                            <div class="pt-2">
                                <button type="submit" class="btn btn-primary w-full">Añadir Usuario</button>
                            </div>
                        </form>
                    </div>
                    <div class="content-card">
                        <h3 class="text-xl font-semibold text-white mb-4">Usuarios Existentes</h3>
                        <ul id="lista-usuarios" class="space-y-2">
                        </ul>
                    </div>
                </div>
            </div>

            <!-- TAB ADMIN IRPF -->
            <div id="admin-irpf" class="admin-tab-content">
                <div class="content-card max-w-6xl mx-auto">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-2xl font-bold text-white">Configuración de IRPF</h3>
                        <select id="irpf-anio-select" class="form-input p-2 w-32">
                            <option value="2024">2024</option>
                            <option value="2025" selected>2025</option>
                            <option value="2026">2026</option>
                        </select>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <!-- COLUMNA 1: TRAMOS IRPF -->
                        <div>
                            <h4 class="text-lg font-semibold text-white mb-4">Tramos IRPF (Bruto Anual)</h4>
                            <div class="overflow-x-auto mb-4">
                                <table class="w-full text-left border-collapse">
                                    <thead>
                                        <tr class="text-gray-400 border-b border-gray-700">
                                            <th class="p-2">Desde (€)</th>
                                            <th class="p-2">Hasta (€)</th>
                                            <th class="p-2">%</th>
                                            <th class="p-2"></th>
                                        </tr>
                                    </thead>
                                    <tbody id="tabla-irpf-body">
                                        <!-- JS render lines -->
                                    </tbody>
                                </table>
                            </div>
                            <button type="button" id="btn-add-tramo-irpf" class="btn btn-secondary text-sm mb-4">+
                                Añadir Tramo</button>
                        </div>

                        <!-- COLUMNA 2: MÍNIMOS EXENTOS (MODELO 145) -->
                        <div>
                            <h4 class="text-lg font-semibold text-white mb-4">Mínimos Personales y Familiares</h4>
                            <div class="space-y-3">
                                <div>
                                    <label class="block text-sm text-gray-400">Mínimo Contribuyente (€)</label>
                                    <input type="number" id="irpf-min-contribuyente" class="w-full form-input p-1"
                                        value="5550">
                                </div>
                                <div>
                                    <label class="block text-sm text-gray-400">Por Descendiente (1º) (€)</label>
                                    <input type="number" id="irpf-min-hijo1" class="w-full form-input p-1" value="2400">
                                </div>
                                <div>
                                    <label class="block text-sm text-gray-400">Por Descendiente (2º) (€)</label>
                                    <input type="number" id="irpf-min-hijo2" class="w-full form-input p-1" value="2700">
                                </div>
                                <div>
                                    <label class="block text-sm text-gray-400">Por Descendiente (3º) (€)</label>
                                    <input type="number" id="irpf-min-hijo3" class="w-full form-input p-1" value="4000">
                                </div>
                                <div>
                                    <label class="block text-sm text-gray-400">Por Ascendiente (> 65) (€)</label>
                                    <input type="number" id="irpf-min-ascendiente" class="w-full form-input p-1"
                                        value="1150">
                                </div>
                                <div>
                                    <label class="block text-sm text-gray-400">Plus Discapacidad (>= 33%) (€)</label>
                                    <input type="number" id="irpf-min-discapacidad" class="w-full form-input p-1"
                                        value="3000">
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="mt-6 border-t border-gray-700 pt-4 flex justify-end">
                        <button type="button" id="btn-save-irpf" class="btn btn-primary">Guardar Configuración
                            IRPF</button>
                    </div>
                </div>
            </div>
        </div>


        <div id="nominas" class="page-content">
            <h2 class="text-3xl font-bold text-white mb-6">Generar Nómina</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                <div class="md:col-span-1 content-card">
                    <h3 class="text-xl font-semibold text-white mb-4">Parámetros de Cálculo</h3>
                    <form id="form-nomina" class="space-y-4">
                        <div>
                            <label for="nomina-empleado" class="block mb-1 text-sm font-medium">Empleado</label>
                            <select id="nomina-empleado" class="w-full form-input p-2" required></select>
                        </div>

                        <!-- TOGGLE MODO MANUAL -->
                        <div class="bg-gray-700 p-3 rounded flex items-center">
                            <input type="checkbox" id="manual-mode-toggle"
                                class="mr-3 h-5 w-5 rounded bg-gray-600 border-gray-500 text-blue-600 focus:ring-blue-500">
                            <label for="manual-mode-toggle" class="text-sm text-gray-200 select-none font-bold">Activar
                                Modo
                                Manual</label>
                        </div>

                        <!-- CAMPOS MANUALES -->
                        <div id="manual-mode-fields"
                            class="space-y-4 border border-blue-500 p-4 rounded-lg hidden bg-gray-800">
                            <h4 class="text-blue-400 font-semibold mb-2">Datos Manuales</h4>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-xs text-gray-400 mb-1">Salario Base</label>
                                    <input type="number" step="0.01" id="manual-salario-base"
                                        class="w-full form-input p-2 text-sm" placeholder="0.00">
                                </div>
                                <div>
                                    <label class="block text-xs text-gray-400 mb-1">Prorrata Extra</label>
                                    <input type="number" step="0.01" id="manual-prorrata"
                                        class="w-full form-input p-2 text-sm" placeholder="0.00">
                                </div>
                                <div>
                                    <label class="block text-xs text-gray-400 mb-1">Plus Convenio / CPP</label>
                                    <input type="number" step="0.01" id="manual-plus-convenio"
                                        class="w-full form-input p-2 text-sm" placeholder="0.00">
                                </div>
                                <div>
                                    <label class="block text-xs text-gray-400 mb-1">Base Cotización Total</label>
                                    <input type="number" step="0.01" id="manual-base-cotizacion"
                                        class="w-full form-input p-2 text-sm" placeholder="0.00">
                                </div>
                                <div>
                                    <label class="block text-xs text-gray-400 mb-1">Prestación Baja</label>
                                    <input type="number" step="0.01" id="manual-prestacion-baja"
                                        class="w-full form-input p-2 text-sm" placeholder="0.00">
                                </div>
                                <div>
                                    <label class="block text-xs text-gray-400 mb-1">Complemento Baja</label>
                                    <input type="number" step="0.01" id="manual-complemento-baja"
                                        class="w-full form-input p-2 text-sm" placeholder="0.00">
                                </div>
                            </div>
                        </div>
                        <div>
                            <label for="nomina-fecha-inicio" class="block mb-1 text-sm font-medium">Fecha de
                                Inicio</label>
                            <input type="date" id="nomina-fecha-inicio" class="w-full form-input p-2" required>
                        </div>
                        <div>
                            <label for="nomina-fecha-fin" class="block mb-1 text-sm font-medium">Fecha de Fin</label>
                            <input type="date" id="nomina-fecha-fin" class="w-full form-input p-2" required>
                        </div>
                        <fieldset id="fieldset-baja" class="border border-gray-600 p-4 rounded-lg">
                            <legend class="text-sm font-medium px-2">Periodo de Baja (Opcional)</legend>
                            <div class="space-y-4">
                                <div>
                                    <label for="nomina-baja-inicio" class="block mb-1 text-sm font-medium">Inicio de la
                                        Baja</label>
                                    <input type="date" id="nomina-baja-inicio" class="w-full form-input p-2">
                                </div>
                                <div>
                                    <label for="nomina-baja-fin" class="block mb-1 text-sm font-medium">Fin de la
                                        Baja</label>
                                    <input type="date" id="nomina-baja-fin" class="w-full form-input p-2">
                                </div>
                                <div>
                                    <label for="nomina-base-mes-anterior" class="block mb-1 text-sm font-medium">Base
                                        Cotización Mes Anterior a la Baja (€)</label>
                                    <input type="number" step="0.01" id="nomina-base-mes-anterior"
                                        class="w-full form-input p-2" placeholder="Ej: 2000.00">
                                    <p class="text-xs text-gray-400 mt-1">Requerido si hay baja para el cálculo correcto
                                        de la cotización.</p>
                                    <div id="base-sugerencia-container"
                                        class="mt-1 hidden cursor-pointer bg-blue-900 border border-blue-700 rounded p-2 text-sm text-blue-200 hover:bg-blue-800 transition-colors flex items-center">
                                        <i data-lucide="lightbulb" class="w-4 h-4 mr-2 text-yellow-400"></i>
                                        <span id="base-sugerencia-texto"></span>
                                    </div>
                                </div>
                            </div>
                        </fieldset>

                        <fieldset class="border border-gray-600 p-4 rounded-lg">
                            <legend class="text-sm font-medium px-2">Ajustes Manuales</legend>
                            <div class="space-y-4">
                                <div>
                                    <label for="nomina-irpf" class="block mb-1 text-sm font-medium">IRPF (%) <span
                                            id="irpf-sugerido-label"
                                            class="ml-2 text-xs text-blue-400 font-normal"></span></label>
                                    <input type="number" step="0.01" id="nomina-irpf" class="w-full form-input p-2"
                                        value="0.00" required>
                                </div>
                                -->
                                <div>
                                    <label class="block mb-2 text-sm font-medium">Otros Devengos</label>
                                    <div class="flex space-x-2 items-center">
                                        <select id="select-devengo" class="w-full form-input p-2 text-sm">
                                        </select>
                                        <button type="button" id="add-devengo-btn" class="p-2 btn-secondary rounded-md">
                                            <i data-lucide="plus" class="w-5 h-5"></i>
                                        </button>
                                    </div>
                                    <div id="otros-devengos-container" class="space-y-2 mt-2">
                                    </div>
                                </div>
                                -->
                                <div>
                                    <label class="block mb-2 mt-4 text-sm font-medium">Otras Deducciones</label>
                                    <div class="flex space-x-2 items-center">
                                        <select id="select-deduccion" class="w-full form-input p-2 text-sm">
                                        </select>
                                        <button type="button" id="add-deduccion-btn"
                                            class="p-2 btn-secondary rounded-md">
                                            <i data-lucide="plus" class="w-5 h-5"></i>
                                        </button>
                                    </div>
                                    <div id="otras-deducciones-container" class="space-y-2 mt-2">
                                    </div>
                                </div>
                            </div>
                        </fieldset>

                        <div class="pt-2">
                            <button type="submit" class="btn btn-primary w-full">Calcular Nómina</button>
                        </div>
                    </form>
                </div>
                <div id="nomina-resultado-container" class="md:col-span-2 content-card hidden">
                    <h3 class="text-xl font-semibold text-white mb-4">Resultado de la Nómina</h3>

                    <div id="nomina-resultado"></div>

                    <div class="mt-6 flex justify-end space-x-4">
                        <button id="btn-guardar-individual-bd"
                            class="btn btn-primary bg-green-600 hover:bg-green-700 text-white">
                            <i data-lucide="cloud-upload" class="w-4 h-4 mr-2"></i>
                            Guardar en Base de Datos
                        </button>
                        <button id="btn-exportar-nomina" class="btn btn-secondary" style="display: none;">
                            <i data-lucide="download" class="w-4 h-4 mr-2"></i>
                            Exportar a Excel (.csv)
                        </button>
                        <button id="btn-exportar-pdf" class="btn btn-secondary" style="display: none;">
                            <i data-lucide="file-type" class="w-4 h-4 mr-2"></i>
                            Exportar a PDF
                        </button>
                    </div>
                    <div class="mt-6 flex justify-end space-x-4">
                        <button id="btn-guardar-neon" class="btn btn-primary" style="display: none;">
                            <span>Guardar en Nube</span>
                        </button>

                        <button id="btn-exportar-nomina" ...>...</button>
                    </div>
                </div>
            </div>
        </div>
        <div id="nominas-lote" class="page-content">
            <h2 class="text-3xl font-bold text-white mb-6">Generar Nóminas por Lote</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                <div class="md:col-span-1 content-card">
                    <h3 class="text-xl font-semibold text-white mb-4">Parámetros Comunes</h3>
                    <form id="form-nomina-lote" class="space-y-4">
                        <div>
                            <label class="block mb-2 text-sm font-medium">Empleado(s) a Procesar</label>
                            <div class="border border-gray-600 rounded-lg p-3 h-48 overflow-y-auto">
                                <div class="flex items-center border-b border-gray-600 pb-2 mb-2">
                                    <input type="checkbox" id="seleccionar-todos-empleados-lote"
                                        class="mr-2 h-4 w-4 rounded bg-gray-700 border-gray-500 text-blue-600 focus:ring-blue-500">
                                    <label for="seleccionar-todos-empleados-lote"
                                        class="text-sm font-medium">Seleccionar Todos</label>
                                </div>
                                <div id="nomina-lista-empleados-lote" class="space-y-2"> </div>
                            </div>
                        </div>

                        <div>
                            <label for="nomina-fecha-inicio-lote" class="block mb-1 text-sm font-medium">Fecha de
                                Inicio</label> <input type="date" id="nomina-fecha-inicio-lote"
                                class="w-full form-input p-2" required>
                        </div>
                        <div>
                            <label for="nomina-fecha-fin-lote" class="block mb-1 text-sm font-medium">Fecha de
                                Fin</label> <input type="date" id="nomina-fecha-fin-lote" class="w-full form-input p-2"
                                required>
                        </div>

                        <fieldset class="border border-gray-600 p-4 rounded-lg">
                            <legend class="text-sm font-medium px-2">Ajustes Generales</legend>
                            <div>
                                <label for="nomina-irpf-lote" class="block mb-1 text-sm font-medium">IRPF General
                                    (%)</label> <input type="number" step="0.01" id="nomina-irpf-lote"
                                    class="w-full form-input p-2" value="0.00" required>
                                <p class="text-xs text-gray-400 mt-1">Se aplicará a todos los empleados seleccionados.
                                </p>
                            </div>
                        </fieldset>

                        <fieldset class="border border-gray-600 p-4 rounded-lg">
                            <legend class="text-sm font-medium px-2">Ajustes Comunes (Opcional)</legend>
                            <p class="text-xs text-gray-400 mb-3">Los conceptos añadidos aquí se aplicarán a **todos**
                                los empleados seleccionados.</p>
                            <div>
                                <label class="block mb-2 text-sm font-medium">Otros Devengos Comunes</label>
                                <div class="flex space-x-2 items-center">
                                    <select id="select-devengo-lote" class="w-full form-input p-2 text-sm">...</select>
                                    <button type="button" id="add-devengo-lote-btn"
                                        class="p-2 btn-secondary rounded-md">...</button>
                                </div>
                                <div id="otros-devengos-lote-container" class="space-y-2 mt-2">...</div>
                            </div>
                            <div class="mt-4">
                                <label class="block mb-2 text-sm font-medium">Otras Deducciones Comunes</label>
                                <div class="flex space-x-2 items-center">
                                    <select id="select-deduccion-lote"
                                        class="w-full form-input p-2 text-sm">...</select>
                                    <button type="button" id="add-deduccion-lote-btn"
                                        class="p-2 btn-secondary rounded-md">...</button>
                                </div>
                                <div id="otras-deducciones-lote-container" class="space-y-2 mt-2">...</div>
                            </div>
                        </fieldset>

                        <div class="pt-2">
                            <button type="submit" class="btn btn-primary w-full">Calcular Nóminas Lote</button>
                        </div>
                    </form>
                </div>

                <div id="nomina-lote-resultado-container" class="md:col-span-2 content-card hidden">
                    <div class="flex justify-between items-center mb-4">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl font-semibold text-white">Resultado del Lote</h3>

                            <div class="flex space-x-2">
                                <button id="btn-guardar-lote-bd"
                                    class="btn btn-primary bg-green-600 hover:bg-green-700 text-white"
                                    style="display: none;">
                                    <i data-lucide="cloud-upload" class="w-4 h-4 mr-2"></i>
                                    Guardar Lote en BD
                                </button>
                                <button id="btn-exportar-lote-csv" class="btn btn-secondary" style="display: none;">
                                    <i data-lucide="download" class="w-4 h-4 mr-2"></i>
                                    Exportar Lote (.csv)
                                </button>
                                <button id="btn-exportar-lote-pdf" class="btn btn-secondary" style="display: none;">
                                    <i data-lucide="file-type" class="w-4 h-4 mr-2"></i>
                                    Exportar Lote (PDF)
                                </button>
                            </div>

                        </div>

                    </div>
                    <div id="nomina-lote-resultado"></div>
                </div>
            </div>
        </div>
        <div id="historial-page" class="page-content">
            <h2 class="text-3xl font-bold text-white mb-6">Historial de Nóminas</h2>
            <div class="content-card">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-semibold text-white">Registros Guardados</h3>
                    <button id="btn-refresh-historial" class="btn btn-secondary text-xs">
                        <i data-lucide="refresh-cw" class="w-4 h-4 mr-2"></i> Actualizar
                    </button>
                </div>
                <div class="overflow-x-auto">
                    <table id="tabla-historial" class="w-full data-table">
                        <thead>
                            <tr>
                                <th>Fecha Emisión</th>
                                <th>Empleado</th>
                                <th>Periodo</th>
                                <th>Total Devengado</th>
                                <th>Líquido</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="tabla-historial-body">
                            <!-- JS injected -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>
    </div>
    <div id="custom-modal-overlay"
        class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center hidden z-50">
        <div id="custom-modal" class="bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-md mx-4">
            <h3 id="modal-title" class="text-xl font-bold text-white mb-4"></h3>
            <p id="modal-message" class="text-gray-300 mb-6"></p>
            <div id="modal-buttons" class="flex justify-end space-x-4">
            </div>
        </div>
    </div>
    </div>
    </div>

    <!-- MODAL PARA VER DETALLE DE NÓMINA (LOTE) -->
    <div id="nomina-detail-modal-overlay"
        class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center hidden z-50">
        <div class="bg-gray-800 rounded-lg shadow-xl w-full max-w-2xl mx-4 flex flex-col max-h-[90vh]">
            <div class="p-6 border-b border-gray-700 flex justify-between items-center">
                <h3 id="nomina-detail-modal-title" class="text-xl font-bold text-white">Detalle de Nómina</h3>
                <button id="close-nomina-detail-modal" class="text-gray-400 hover:text-white">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>
            <div id="nomina-detail-modal-content" class="p-6 overflow-y-auto flex-1 text-sm text-gray-300">
                <!-- Content injected by JS -->
            </div>
            <div class="p-6 border-t border-gray-700 flex justify-end">
                <button id="btn-close-detail-modal" class="btn btn-secondary">Cerrar</button>
            </div>
        </div>
    </div>

    <!-- MODAL ESPECÍFICO PARA DETALLES DE LOTE -->
    <div id="batch-employee-modal-overlay"
        class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center hidden z-50">
        <div class="bg-gray-800 rounded-lg shadow-xl w-full max-w-lg mx-4 flex flex-col max-h-[90vh]">
            <div class="p-6 border-b border-gray-700">
                <h3 id="batch-modal-title" class="text-xl font-bold text-white">Detalles del Empleado</h3>
            </div>

            <div class="p-6 overflow-y-auto flex-1 space-y-6">
                <input type="hidden" id="batch-modal-emp-id">

                <!-- Excluir Ajustes Comunes -->
                <div class="bg-gray-700 p-3 rounded flex items-center mb-4">
                    <input type="checkbox" id="batch-modal-exclude-common"
                        class="mr-3 h-5 w-5 rounded bg-gray-600 border-gray-500 text-blue-600 focus:ring-blue-500">
                    <label for="batch-modal-exclude-common" class="text-sm text-gray-200 select-none">Excluir Ajustes
                        Comunes (Devengos y Deducciones Globales)</label>
                </div>

                <!-- Baja -->
                <div class="bg-gray-900 p-4 rounded-lg space-y-3">
                    <h4 class="text-sm font-semibold text-blue-400">Baja / Incapacidad Temporal</h4>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-xs text-gray-400 mb-1">Inicio Baja</label>
                            <input type="date" id="batch-modal-baja-inicio" class="w-full form-input p-2 text-sm">
                        </div>
                        <div>
                            <label class="block text-xs text-gray-400 mb-1">Fin Baja</label>
                            <input type="date" id="batch-modal-baja-fin" class="w-full form-input p-2 text-sm">
                        </div>
                    </div>
                    <div>
                        <label class="block text-xs text-gray-400 mb-1">Base Mes Anterior (si hay baja)</label>
                        <input type="number" step="0.01" id="batch-modal-base-anterior"
                            class="w-full form-input p-2 text-sm" placeholder="0.00">
                    </div>
                </div>

                <!-- IRPF -->
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-1">IRPF Específico (%)</label>
                    <input type="number" step="0.01" id="batch-modal-irpf" class="w-full form-input p-2"
                        placeholder="Dejar vacío para usar general">
                </div>

                <!-- Devengos Específicos -->
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">Otros Devengos Específicos</label>
                    <div class="flex space-x-2 mb-3">
                        <select id="batch-modal-devengo-select" class="w-full form-input p-2 text-sm">
                            <!-- Options populated by JS -->
                        </select>
                        <input type="number" id="batch-modal-devengo-amount" placeholder="Importe"
                            class="w-24 form-input p-2 text-sm" step="0.01">
                        <button type="button" id="batch-modal-add-devengo-btn" class="btn btn-secondary p-2">
                            <i data-lucide="plus" class="w-5 h-5"></i>
                        </button>
                    </div>
                    <div id="batch-modal-devengos-list" class="space-y-2"></div>
                </div>

                <!-- Deducciones Específicas -->
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">Otras Deducciones Específicas</label>
                    <div class="flex space-x-2 mb-3">
                        <select id="batch-modal-deduccion-select" class="w-full form-input p-2 text-sm">
                            <!-- Options populated by JS -->
                        </select>
                        <input type="number" id="batch-modal-deduccion-amount" placeholder="Importe"
                            class="w-24 form-input p-2 text-sm" step="0.01">
                        <button type="button" id="batch-modal-add-deduccion-btn" class="btn btn-secondary p-2">
                            <i data-lucide="plus" class="w-5 h-5"></i>
                        </button>
                    </div>
                    <div id="batch-modal-deducciones-list" class="space-y-2"></div>
                </div>
            </div>

            <div class="p-6 border-t border-gray-700 flex justify-end space-x-3">
                <button type="button" id="batch-modal-cancel-btn" class="btn btn-secondary">Cancelar</button>
                <button type="button" id="batch-modal-save-btn" class="btn btn-primary">Guardar Cambios</button>
            </div>
        </div>
    </div>

    <input type="file" id="import-file-input" class="hidden" accept="application/json">

    <script src="nominas.js"></script>
    -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {

            // ==========================================================
            // --- LÓGICA DEL MODAL PERSONALIZADO ---
            // ==========================================================
            const modalOverlay = document.getElementById('custom-modal-overlay');
            const modalTitle = document.getElementById('modal-title');
            const modalMessage = document.getElementById('modal-message');
            const modalButtons = document.getElementById('modal-buttons');

            const logoutButton = document.getElementById('logout-button');
            if (logoutButton) {
                logoutButton.addEventListener('click', () => {
                    sessionStorage.removeItem('isLoggedIn'); // Borra la señal de sesión
                    window.location.href = 'login.html'; // Redirige al login
                });
            }

            const hideModal = () => {
                modalOverlay.classList.add('hidden');
            };

            const showModal = ({ title, message, type = 'alert', onConfirm = () => { }, onCancel = () => { } }) => {
                modalTitle.textContent = title;
                modalMessage.textContent = message;
                modalButtons.innerHTML = '';

                if (type === 'confirm') {
                    const cancelButton = document.createElement('button');
                    cancelButton.textContent = 'Cancelar';
                    cancelButton.className = 'btn btn-secondary';
                    cancelButton.onclick = () => {
                        hideModal();
                        onCancel();
                    };
                    modalButtons.appendChild(cancelButton);
                }

                const confirmButton = document.createElement('button');
                confirmButton.textContent = 'Aceptar';
                confirmButton.className = 'btn btn-primary';
                confirmButton.onclick = () => {
                    hideModal();
                    onConfirm();
                };
                modalButtons.appendChild(confirmButton);

                modalOverlay.classList.remove('hidden');
            };

            modalOverlay.addEventListener('click', (e) => {
                if (e.target === modalOverlay) {
                    hideModal();
                }
            });

            // --- ICONOS LUCIDE ---
            lucide.createIcons();

            // --- NUEVA LÓGICA DE DATOS CON API ---
            let puestos = [];
            let empleados = [];
            let configSS = JSON.parse(localStorage.getItem('configSS')) || {}; // Config local está bien
            let conceptos = JSON.parse(localStorage.getItem('conceptos')) || { devengos: [], deducciones: [] };
            let empresa = JSON.parse(localStorage.getItem('empresa')) || {};
            let tiposContrato = JSON.parse(localStorage.getItem('tiposContrato')) || [];
            let users = [];


            // Función para guardar configuraciones genéricas en BD
            const guardarConfigEnBD = async (clave, datos) => {
                try {
                    await fetch(`/api/config/${clave}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(datos)
                    });
                } catch (err) {
                    console.error(`Error guardando ${clave}:`, err);
                }
            };

            const loadDataFromDB = async () => {
                try {
                    // 1. Cargar Entidades Principales
                    const resPuestos = await fetch('/api/puestos');
                    puestos = await resPuestos.json() || [];

                    const resEmpleados = await fetch('/api/empleados');
                    empleados = await resEmpleados.json() || [];

                    // 2. Cargar Configuraciones (Si devuelve null, usamos valor por defecto)
                    const resEmpresa = await fetch('/api/config/empresa');
                    const datosEmpresa = await resEmpresa.json();
                    if (datosEmpresa) empresa = datosEmpresa;

                    const resSS = await fetch('/api/config/ss');
                    const datosSS = await resSS.json();
                    if (datosSS) configSS = datosSS;

                    const resConceptos = await fetch('/api/config/conceptos');
                    const datosConceptos = await resConceptos.json();
                    if (datosConceptos) conceptos = datosConceptos;

                    const resContratos = await fetch('/api/config/contratos');
                    const datosContratos = await resContratos.json();
                    if (datosContratos) tiposContrato = datosContratos;

                    // 3. Cargar Usuarios (Solo si es admin)
                    if (sessionStorage.getItem('loggedInUser') === 'admin') {
                        const resUsers = await fetch('/api/usuarios');
                        users = await resUsers.json() || [];
                    }

                    // 4. Renderizar UI
                    renderPuestos();
                    renderEmpleados();
                    loadConfigSS(); // Rellena los inputs de SS con lo descargado
                    loadEmpresaData(); // Rellena los inputs de Empresa
                    renderConceptos(); // Rellena listas de devengos/deducciones
                    renderTiposContrato();
                    if (sessionStorage.getItem('loggedInUser') === 'admin') renderUsuariosList();
                    renderEmployeeSelectionListLote();

                    console.log("Todos los datos sincronizados con la Nube.");
                } catch (err) {
                    console.error("Error cargando datos:", err);
                }
            };

            // Variable para guardar el resultado de la última nómina calculada
            let ultimaNominaCalculada = null;

            // ==========================================================
            // --- DEFINICIONES DE ELEMENTOS GLOBALES ---
            // ==========================================================
            const formPuesto = document.getElementById('form-puesto');
            const listaPuestos = document.querySelector('#lista-puestos tbody');
            const formPuestoTitulo = document.getElementById('form-puesto-titulo');
            const puestoIdInput = document.getElementById('puesto-id');
            const cancelarEdicionPuestoBtn = document.getElementById('cancelar-edicion-puesto');
            const empleadoPuestoSelect = document.getElementById('empleado-puesto');
            const formEmpleado = document.getElementById('form-empleado');
            const listaEmpleados = document.querySelector('#lista-empleados tbody');
            const formEmpleadoTitulo = document.getElementById('form-empleado-titulo');
            const empleadoIdInput = document.getElementById('empleado-id');
            const cancelarEdicionEmpleadoBtn = document.getElementById('cancelar-edicion-empleado');
            const formNomina = document.getElementById('form-nomina');
            const nominaEmpleadoSelect = document.getElementById('nomina-empleado');
            const nominaResultadoContainer = document.getElementById('nomina-resultado-container');
            const nominaResultadoDiv = document.getElementById('nomina-resultado');
            const btnGuardarIndividualBd = document.getElementById('btn-guardar-individual-bd');
            const btnGuardarLoteBd = document.getElementById('btn-guardar-lote-bd');

            // ==========================================================
            // --- FUNCIONES DE AYUDA (Fechas, etc.) ---
            // ==========================================================
            const formatDateToYMD = (date) => {
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            };

            const setDefaultNominaDates = () => {
                const today = new Date();
                const firstDay = formatDateToYMD(new Date(today.getFullYear(), today.getMonth(), 1));
                const lastDay = formatDateToYMD(new Date(today.getFullYear(), today.getMonth() + 1, 0));
                document.getElementById('nomina-fecha-inicio').value = firstDay;
                document.getElementById('nomina-fecha-fin').value = lastDay;
            };

            // ==========================================================
            // --- LÓGICA DE NAVEGACIÓN ---
            // ==========================================================
            const navLinks = document.querySelectorAll('.nav-link');
            const pageContents = document.querySelectorAll('.page-content');

            function showPage(targetId) {
                pageContents.forEach(page => {
                    page.classList.toggle('active', page.id === targetId);
                });
                navLinks.forEach(link => {
                    link.classList.toggle('bg-gray-700', link.dataset.target === targetId);
                });
                localStorage.setItem('activePage', targetId);

                // Ahora, encuentra y muestra SOLO la sección correcta
                const targetPage = document.getElementById(targetId);
                if (targetPage) {
                    targetPage.classList.add('active');
                }

                // Activa SOLO el enlace del menú correspondiente
                const targetLink = document.querySelector(`.nav-link[data-target="${targetId}"]`);
                if (targetLink) {
                    targetLink.classList.add('bg-gray-700');
                }

                // Guarda la última página visitada (excepto la de inicio)
                if (targetId !== 'home-page') {
                    localStorage.setItem('activePage', targetId);
                } else {
                    localStorage.removeItem('activePage');
                }

                /// --- LÓGICA ESPECÍFICA DE INICIALIZACIÓN POR PÁGINA ---
                if (targetId === 'empleados') {
                    renderTiposContratoDropdown();
                } else if (targetId === 'admin') {
                    const currentAdminTab = document.querySelector('#admin .tab-button.active')?.dataset.target || 'admin-ss';
                    showAdminTab(currentAdminTab); // Muestra la última pestaña activa o la primera
                    // Asegúrate de que los datos de las pestañas estén cargados
                    renderConceptos();
                    loadEmpresaData();
                    renderTiposContrato();
                    if (sessionStorage.getItem('loggedInUser') === 'admin') {
                        renderUsuariosList();
                    }
                } else if (targetId === 'nominas') { // Individual
                    renderEmpleadosDropdownNomina();
                    setDefaultNominaDates(); // Asume que los IDs son nomina-fecha-inicio / fin
                    renderConceptoDropdowns();
                    // Opcional: Limpiar resultados de lote si estaban visibles
                    nominaLoteResultadoContainer?.classList.add('hidden');
                } else if (targetId === 'historial-page') {
                    renderHistorial();
                }

                // --- Control de visibilidad de la pestaña Usuarios (solo si estamos en Admin) ---
                const tabUsuarios = document.getElementById('tab-admin-usuarios');
                if (tabUsuarios) {
                    const loggedInUser = sessionStorage.getItem('loggedInUser');
                    if (targetId === 'admin' && loggedInUser === 'admin') {
                        tabUsuarios.classList.remove('hidden');
                    } else {
                        tabUsuarios.classList.add('hidden');
                        // Si intentan acceder a la pestaña sin ser admin, redirige
                        const activeAdminTab = document.querySelector('#admin .tab-button.active');
                        if (activeAdminTab && activeAdminTab.dataset.target === 'admin-usuarios') {
                            showAdminTab('admin-ss');
                        }
                    }
                }
            }

            const setDefaultNominaDatesLote = () => {
                const today = new Date();
                const firstDay = formatDateToYMD(new Date(today.getFullYear(), today.getMonth(), 1));
                const lastDay = formatDateToYMD(new Date(today.getFullYear(), today.getMonth() + 1, 0));
                // Asegúrate de que los IDs coincidan con tu HTML de lote
                if (nominaFechaInicioLote) nominaFechaInicioLote.value = firstDay;
                if (nominaFechaFinLote) nominaFechaFinLote.value = lastDay;
            };

            // ==========================================================
            // --- LÓGICA DE PUESTOS DE TRABAJO ---
            // ==========================================================
            const renderPuestosDropdown = () => {
                const currentPuestoId = empleadoPuestoSelect.value;
                empleadoPuestoSelect.innerHTML = '<option value="">Selecciona un puesto...</option>';
                puestos.forEach(puesto => {
                    const option = document.createElement('option');
                    option.value = puesto.id;
                    option.textContent = puesto.nombre;
                    empleadoPuestoSelect.appendChild(option);
                });
                empleadoPuestoSelect.value = currentPuestoId;
            };

            const renderPuestos = () => {
                listaPuestos.innerHTML = '';
                if (puestos.length === 0) {
                    listaPuestos.innerHTML = '<tr><td colspan="4" class="text-center text-gray-500 py-4">No hay puestos registrados.</td></tr>';
                    return;
                }
                puestos.forEach(puesto => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                <td>${puesto.nombre}</td>
                <td>${parseFloat(puesto.salario).toFixed(2)} €</td>
                <td>${parseFloat(puesto.horas).toFixed(1)}</td>
                <td class="flex space-x-2">
                    <button class="p-2 text-blue-400 hover:text-blue-200" onclick="app.editarPuesto('${puesto.id}')"><i data-lucide="edit" class="w-5 h-5"></i></button>
                    <button class="p-2 text-red-500 hover:text-red-300" onclick="app.borrarPuesto('${puesto.id}')"><i data-lucide="trash-2" class="w-5 h-5"></i></button>
                </td>
            `;
                    listaPuestos.appendChild(tr);
                });
                lucide.createIcons();
                renderPuestosDropdown();
            };

            const resetFormPuesto = () => {
                formPuesto.reset();
                puestoIdInput.value = '';
                renderConceptosDelPuesto([]);
                formPuestoTitulo.textContent = 'Crear Nuevo Puesto';
                cancelarEdicionPuestoBtn.classList.add('hidden');
            };

            // --- LÓGICA DE GUARDADO DE PUESTOS EN BASE DE DATOS ---
            formPuesto.addEventListener('submit', async (e) => {
                e.preventDefault();

                const id = puestoIdInput.value;
                // Si no hay ID, generamos uno nuevo.
                // Nota: Es importante mantener el formato string para el backend.
                const finalId = id || `p_${Date.now()}`;

                // 1. Recopilar Conceptos Adicionales (Antigüedad, etc.) del DOM
                // (Esta lógica se mantiene igual que en tu versión local)
                const conceptosContainer = document.getElementById('conceptos-adicionales-container');
                const conceptosAdicionales = Array.from(conceptosContainer.children).map(div => {
                    const spanText = div.querySelector('span').textContent;
                    // Parseamos el texto para sacar los valores: "Nombre - 100€ cada 3 año(s)"
                    const [mainText] = spanText.split(' - ');
                    const match = spanText.match(/(\d+\.?\d*)€ cada (\d+) año\(s\)/);

                    let importe = '0';
                    let periodicidad = '0';

                    if (match) {
                        importe = match[1];
                        periodicidad = match[2];
                    }

                    return {
                        nombre: mainText,
                        importe: importe,
                        periodicidadAnios: periodicidad
                    };
                });

                // 2. Construir objeto de datos
                const puestoData = {
                    id: finalId,
                    nombre: document.getElementById('puesto-nombre').value,
                    salario: document.getElementById('puesto-salario').value,
                    horas: document.getElementById('puesto-horas').value,
                    conceptosAdicionales: conceptosAdicionales,
                };

                // 3. Enviar a la Nube (API)
                try {
                    const submitBtn = formPuesto.querySelector('button[type="submit"]');
                    const originalText = submitBtn.textContent;
                    submitBtn.textContent = "Guardando...";
                    submitBtn.disabled = true;

                    const response = await fetch('/api/puestos', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(puestoData)
                    });

                    const result = await response.json();

                    if (result.success) {
                        // Recargar datos desde la BD para actualizar la tabla
                        await loadDataFromDB();
                        resetFormPuesto();
                        showModal({ title: "Éxito", message: "Puesto guardado en la base de datos." });
                    } else {
                        throw new Error(result.error || "Error al guardar el puesto");
                    }

                } catch (error) {
                    console.error(error);
                    showModal({ title: "Error", message: "No se pudo guardar: " + error.message });
                } finally {
                    const submitBtn = formPuesto.querySelector('button[type="submit"]');
                    if (submitBtn) {
                        submitBtn.textContent = originalText || "Guardar Puesto";
                        submitBtn.disabled = false;
                    }
                }
            });

            // --- LÓGICA PARA GESTIONAR CONCEPTOS DENTRO DE UN PUESTO ---
            const conceptosContainer = document.getElementById('conceptos-adicionales-container');
            const btnAddConceptoPuesto = document.getElementById('btn-add-concepto-puesto');

            // Función para renderizar la lista de conceptos de un puesto en el formulario
            const renderConceptosDelPuesto = (conceptos = []) => {
                conceptosContainer.innerHTML = '';
                conceptos.forEach((concepto, index) => {
                    const div = document.createElement('div');
                    div.className = 'flex justify-between items-center bg-gray-700 p-2 rounded text-sm';
                    div.dataset.index = index;
                    div.innerHTML = `
                <span>${concepto.nombre} - ${concepto.importe}€ cada ${concepto.periodicidadAnios} año(s)</span>
                <button type="button" class="p-1 text-red-400 hover:text-red-200 remove-concepto-puesto-btn">
                    <i data-lucide="trash-2" class="w-4 h-4"></i>
                </button>`;
                    conceptosContainer.appendChild(div);
                });
                lucide.createIcons();
            };

            // Listener para el botón "Añadir Concepto al Puesto"
            btnAddConceptoPuesto.addEventListener('click', () => {
                const nombre = document.getElementById('new-concepto-nombre').value;
                const importe = document.getElementById('new-concepto-importe').value;
                const periodicidadAnios = document.getElementById('new-concepto-periodicidad').value;

                if (!nombre || !importe || !periodicidadAnios) {
                    showModal({ title: "Error", message: "Debes rellenar nombre, importe y periodicidad del concepto." });
                    return;
                }

                const nuevoConcepto = { nombre, importe, periodicidadAnios };

                // Obtenemos los conceptos actuales del formulario para no perderlos
                const conceptosActuales = Array.from(conceptosContainer.children).map(div => {
                    const [mainText] = div.querySelector('span').textContent.split(' - ');
                    const [, importe, periodicidad] = div.querySelector('span').textContent.match(/(\d+\.?\d*)€ cada (\d+) año\(s\)/);
                    return { nombre: mainText, importe, periodicidadAnios: periodicidad };
                });

                conceptosActuales.push(nuevoConcepto);
                renderConceptosDelPuesto(conceptosActuales);

                // Limpiamos los inputs
                document.getElementById('new-concepto-nombre').value = '';
                document.getElementById('new-concepto-importe').value = '';
                document.getElementById('new-concepto-periodicidad').value = '';
            });

            // Listener para borrar un concepto de la lista del formulario
            conceptosContainer.addEventListener('click', (e) => {
                if (e.target.closest('.remove-concepto-puesto-btn')) {
                    e.target.closest('div').remove();
                }
            });

            cancelarEdicionPuestoBtn.addEventListener('click', resetFormPuesto);

            window.app = window.app || {};

            app.editarPuesto = (id) => {
                const puesto = puestos.find(p => p.id === id);
                if (puesto) {
                    puestoIdInput.value = puesto.id;
                    document.getElementById('puesto-nombre').value = puesto.nombre;
                    document.getElementById('puesto-salario').value = puesto.salario;
                    document.getElementById('puesto-horas').value = puesto.horas;

                    // Cargamos y renderizamos los conceptos del puesto
                    renderConceptosDelPuesto(puesto.conceptosAdicionales || []);

                    formPuestoTitulo.textContent = `Editar Puesto: ${puesto.nombre}`;
                    cancelarEdicionPuestoBtn.classList.remove('hidden');
                }
            };

            // --- LÓGICA DE BORRADO DE PUESTOS EN BASE DE DATOS ---
            app.borrarPuesto = (id) => {
                showModal({
                    title: 'Confirmar Borrado',
                    message: '¿Estás seguro de que quieres borrar este puesto de trabajo?',
                    type: 'confirm',
                    onConfirm: async () => {
                        // 1. Validación local de seguridad
                        // Verificamos si algún empleado en memoria usa este puesto
                        const empleadoEnPuesto = empleados.some(emp => emp.puestoId === id);

                        if (empleadoEnPuesto) {
                            showModal({
                                title: 'Operación denegada',
                                message: 'No se puede borrar el puesto porque hay empleados asignados a él. Cambia o borra los empleados primero.'
                            });
                            return;
                        }

                        // 2. Si pasa la validación, borramos en la BD
                        try {
                            const response = await fetch(`/api/puestos/${id}`, {
                                method: 'DELETE'
                            });

                            const result = await response.json();

                            if (result.success) {
                                await loadDataFromDB(); // Actualizamos la tabla visual
                            } else {
                                alert("Error al borrar: " + result.error);
                            }
                        } catch (error) {
                            console.error(error);
                            alert("Error de conexión al intentar borrar.");
                        }
                    }
                });
            };

            // ==========================================================
            // --- LÓGICA DE EMPLEADOS ---
            // ==========================================================
            const renderEmpleados = () => {
                listaEmpleados.innerHTML = '';
                if (empleados.length === 0) {
                    listaEmpleados.innerHTML = '<tr><td colspan="5" class="text-center text-gray-500 py-4">No hay empleados registrados.</td></tr>';
                    return;
                }
                empleados.forEach(empleado => {
                    const puesto = puestos.find(p => p.id === empleado.puestoId) || { nombre: 'N/A' };
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                <td>${empleado.nombre}</td>
                <td>${puesto.nombre}</td>
                <td>${empleado.tipoContrato || 'N/A'}<td>${empleado.dni}</td>
                <td class="flex space-x-2">
                    <button class="p-2 text-blue-400 hover:text-blue-200" onclick="app.editarEmpleado('${empleado.id}')"><i data-lucide="edit" class="w-5 h-5"></i></button>
                    <button class="p-2 text-red-500 hover:text-red-300" onclick="app.borrarEmpleado('${empleado.id}')"><i data-lucide="trash-2" class="w-5 h-5"></i></button>
                </td>
            `;
                    listaEmpleados.appendChild(tr);
                });
                lucide.createIcons();
            };
            const resetFormEmpleado = () => {
                formEmpleado.reset();
                empleadoIdInput.value = '';
                // Resetear campos manuales explícitamente si es necesario, aunque form.reset() debería bastar
                // Aseguramos valores por defecto
                document.getElementById('empleado-hijos').value = "0";
                document.getElementById('empleado-ascendientes').value = "0";

                formEmpleadoTitulo.textContent = 'Añadir Nuevo Empleado';
                cancelarEdicionEmpleadoBtn.classList.add('hidden');
            };

            // --- LÓGICA DE GUARDADO DE EMPLEADOS EN BASE DE DATOS ---
            formEmpleado.addEventListener('submit', async (e) => {
                e.preventDefault();

                // 1. Capturamos el ID (si existe es edición, si no es nuevo)
                const id = empleadoIdInput.value;

                // Si no tiene ID, generamos uno nuevo basado en la fecha
                const finalId = id || `e_${Date.now()}`;

                // 2. Recopilamos los datos del formulario
                const empleadoData = {
                    id: finalId,
                    nombre: document.getElementById('empleado-nombre').value,
                    puestoId: document.getElementById('empleado-puesto').value,
                    horas: document.getElementById('empleado-horas').value,
                    tipoContrato: document.getElementById('empleado-tipo-contrato').value,
                    dni: document.getElementById('empleado-dni').value,
                    ss: document.getElementById('empleado-ss').value,
                    antiguedad: document.getElementById('empleado-antiguedad').value,
                    cotizacion: document.getElementById('empleado-cotizacion').value,
                    // Datos Fiscales
                    estadoCivil: document.getElementById('empleado-estado-civil').value,
                    anioNacimiento: document.getElementById('empleado-anio-nacimiento').value,
                    discapacidad: document.getElementById('empleado-discapacidad').value,
                    hijos: document.getElementById('empleado-hijos').value,
                    ascendientes: document.getElementById('empleado-ascendientes').value
                };

                // 3. Enviamos al Servidor (Render -> Neon)
                try {
                    // Bloqueamos el botón o mostramos carga (opcional pero recomendado)
                    const submitBtn = formEmpleado.querySelector('button[type="submit"]');
                    const originalText = submitBtn.textContent;
                    submitBtn.textContent = "Guardando...";
                    submitBtn.disabled = true;

                    const response = await fetch('/api/empleados', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(empleadoData)
                    });

                    const result = await response.json();

                    if (result.success) {
                        // 4. Si todo va bien: Recargamos datos y limpiamos formulario
                        await loadDataFromDB(); // <--- Esta función recarga la lista desde la BD
                        resetFormEmpleado();

                        // Usamos tu modal personalizado
                        showModal({
                            title: "Éxito",
                            message: "Empleado guardado correctamente en la base de datos."
                        });
                    } else {
                        throw new Error(result.error || "Error desconocido al guardar");
                    }

                } catch (error) {
                    console.error(error);
                    showModal({
                        title: "Error",
                        message: "No se pudo guardar el empleado: " + error.message
                    });
                } finally {
                    // Restauramos el botón
                    const submitBtn = formEmpleado.querySelector('button[type="submit"]');
                    if (submitBtn) {
                        submitBtn.textContent = originalText; // "Guardar Empleado"
                        submitBtn.disabled = false;
                    }
                }
            });

            cancelarEdicionEmpleadoBtn.addEventListener('click', resetFormEmpleado);

            app.editarEmpleado = (id) => {
                const empleado = empleados.find(e => e.id === id);
                if (empleado) {
                    empleadoIdInput.value = empleado.id;
                    document.getElementById('empleado-nombre').value = empleado.nombre;
                    document.getElementById('empleado-puesto').value = empleado.puestoId;
                    document.getElementById('empleado-horas').value = empleado.horas;
                    document.getElementById('empleado-tipo-contrato').value = empleado.tipoContrato;
                    document.getElementById('empleado-dni').value = empleado.dni;
                    document.getElementById('empleado-ss').value = empleado.ss;
                    document.getElementById('empleado-antiguedad').value = empleado.antiguedad;
                    document.getElementById('empleado-cotizacion').value = empleado.cotizacion;

                    // Datos Fiscales
                    document.getElementById('empleado-estado-civil').value = empleado.estadoCivil || 'soltero';
                    document.getElementById('empleado-anio-nacimiento').value = empleado.anioNacimiento || '';
                    document.getElementById('empleado-discapacidad').value = empleado.discapacidad || '0';
                    document.getElementById('empleado-hijos').value = empleado.hijos || '0';
                    document.getElementById('empleado-ascendientes').value = empleado.ascendientes || '0';

                    formEmpleadoTitulo.textContent = `Editar Empleado: ${empleado.nombre}`;
                    cancelarEdicionEmpleadoBtn.classList.remove('hidden');
                }
            };

            app.borrarEmpleado = (id) => {
                showModal({
                    title: 'Confirmar Borrado',
                    message: '¿Estás seguro de que quieres borrar este empleado de la base de datos permanentemente?',
                    type: 'confirm', // Esto activa los botones Aceptar/Cancelar en tu modal
                    onConfirm: async () => {
                        try {
                            const response = await fetch(`/api/empleados/${id}`, {
                                method: 'DELETE'
                            });

                            const result = await response.json();

                            if (result.success) {
                                await loadDataFromDB(); // Recargamos la lista visualmente
                                // Opcional: mostrar mensaje de éxito
                            } else {
                                alert("Error al borrar: " + (result.error || "Desconocido"));
                            }
                        } catch (error) {
                            console.error(error);
                            alert("Error de conexión al intentar borrar.");
                        }
                    }
                });
            };

            // ==========================================================
            // --- LÓGICA DE ADMINISTRACIÓN ---
            // ==========================================================
            const formAdmin = document.getElementById('form-admin');
            const adminFields = {
                'ss-cc-empleado': 4.7000, 'ss-desempleo-empleado': 1.5500, 'ss-fp-empleado': 0.1000, 'ss-mei-empleado': 0.1300,
                'ss-cc-empresa': 23.6000, 'ss-at-ep-empresa': 1.5000, 'ss-desempleo-ind-gen-empresa': 5.5000,
                'ss-desempleo-ind-dis-empresa': 4.7000, 'ss-desempleo-tem-gen-empresa': 7.0500,
                'ss-desempleo-tem-dis-empresa': 6.2500, 'ss-fp-empresa': 0.6500, 'ss-fogasa-empresa': 0.2000,
            };

            const loadConfigSS = () => {
                const storedConfig = JSON.parse(localStorage.getItem('configSS')) || {};
                configSS = storedConfig;
                for (const [key, defaultValue] of Object.entries(adminFields)) {
                    const input = document.getElementById(key);
                    if (input) {
                        input.value = configSS[key] !== undefined ? configSS[key] : defaultValue;
                    }
                }
            };

            if (formAdmin) {
                formAdmin.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const newConfig = {};
                    for (const key in adminFields) {
                        const input = document.getElementById(key);
                        if (input) { newConfig[key] = input.value; }
                    }
                    configSS = newConfig;

                    // GUARDAR EN BD
                    await guardarConfigEnBD('ss', configSS);

                    showModal({ title: 'Éxito', message: 'Configuración de SS guardada en la base de datos.' });
                });
            }

            const adminTabs = document.querySelectorAll('#admin .tab-button');
            const adminTabContents = document.querySelectorAll('#admin .admin-tab-content');

            function showAdminTab(targetId) {
                adminTabContents.forEach(content => {
                    content.classList.toggle('active', content.id === targetId);
                });
                adminTabs.forEach(tab => {
                    tab.classList.toggle('active', tab.dataset.target === targetId);
                });
            }

            adminTabs.forEach(tab => {
                tab.addEventListener('click', () => showAdminTab(tab.dataset.target));
            });

            // ==========================================================
            // --- LÓGICA DE CONFIGURACIÓN IRPF (ADMIN) ---
            // ==========================================================
            const irpfDevengosContainer = document.getElementById('admin-irpf'); // Contenedor tab
            const selectIrpfAnio = document.getElementById('irpf-anio-select');
            const tablaIrpfBody = document.getElementById('tabla-irpf-body');
            const btnAddTramoIrpf = document.getElementById('btn-add-tramo-irpf');
            const btnSaveIrpf = document.getElementById('btn-save-irpf');

            let tablasIrpf = {}; // { "2024": [...], "2025": [...] }
            let parametrosIrpf = {}; // { "2025": { contribuyente: 5550, ... } }

            const loadTablasIrpf = async () => {
                try {
                    const [resTablas, resParam] = await Promise.all([
                        fetch('/api/config/tablas_irpf'),
                        fetch('/api/config/parametros_irpf')
                    ]);

                    // Handle Tablas
                    if (resTablas.ok) {
                        const data = await resTablas.json();
                        if (data) tablasIrpf = data;
                    }

                    // Handle Parametros
                    if (resParam.ok) {
                        const data = await resParam.json();
                        if (data) parametrosIrpf = data;
                    }

                    renderTablaIrpf();
                    renderParametrosIrpf();
                } catch (err) {
                    console.error("Error cargando configs IRPF:", err);
                }
            };

            const renderParametrosIrpf = () => {
                const anio = selectIrpfAnio.value;
                const params = parametrosIrpf[anio] || {
                    contribuyente: 5550,
                    hijo1: 2400,
                    hijo2: 2700,
                    hijo3: 4000,
                    ascendiente: 1150,
                    discapacidad: 3000
                };
                document.getElementById('irpf-min-contribuyente').value = params.contribuyente;
                document.getElementById('irpf-min-hijo1').value = params.hijo1;
                document.getElementById('irpf-min-hijo2').value = params.hijo2;
                document.getElementById('irpf-min-hijo3').value = params.hijo3;
                document.getElementById('irpf-min-ascendiente').value = params.ascendiente;
                document.getElementById('irpf-min-discapacidad').value = params.discapacidad;
            };

            const renderTablaIrpf = () => {
                const anio = selectIrpfAnio.value;
                const tramos = tablasIrpf[anio] || [];

                tablaIrpfBody.innerHTML = '';

                // Ordenar por 'desde'
                tramos.sort((a, b) => a.desde - b.desde);

                tramos.forEach((tramo, index) => {
                    const tr = document.createElement('tr');
                    tr.className = 'bg-gray-700';
                    tr.innerHTML = `
                        <td class="p-2"><input type="number" class="form-input w-full text-sm irpf-desde" value="${tramo.desde}"></td>
                        <td class="p-2"><input type="number" class="form-input w-full text-sm irpf-hasta" value="${tramo.hasta || ''}" placeholder="Sin límite"></td>
                        <td class="p-2"><input type="number" step="0.1" class="form-input w-full text-sm irpf-porcentaje" value="${tramo.porcentaje}"></td>
                        <td class="p-2 text-center">
                            <button class="text-red-400 hover:text-red-200" onclick="removeTramoIrpf(${index})">
                                <i data-lucide="trash-2" class="w-4 h-4"></i>
                            </button>
                        </td>
                    `;
                    tablaIrpfBody.appendChild(tr);
                });
                lucide.createIcons();
            };

            window.removeTramoIrpf = (index) => {
                const anio = selectIrpfAnio.value;
                if (tablasIrpf[anio]) {
                    tablasIrpf[anio].splice(index, 1);
                    renderTablaIrpf();
                }
            };

            if (btnAddTramoIrpf) {
                btnAddTramoIrpf.addEventListener('click', () => {
                    const anio = selectIrpfAnio.value;
                    if (!tablasIrpf[anio]) tablasIrpf[anio] = [];

                    // Sugerir el siguiente tramo
                    const lastTramo = tablasIrpf[anio][tablasIrpf[anio].length - 1];
                    const nuevoDesde = lastTramo ? (parseFloat(lastTramo.hasta) || 0) : 0;

                    tablasIrpf[anio].push({ desde: nuevoDesde, hasta: null, porcentaje: 19 });
                    renderTablaIrpf();
                });
            }

            if (selectIrpfAnio) {
                selectIrpfAnio.addEventListener('change', () => {
                    renderTablaIrpf();
                    renderParametrosIrpf();
                });
            }

            if (btnSaveIrpf) {
                btnSaveIrpf.addEventListener('click', async () => {
                    const anio = selectIrpfAnio.value;

                    // Recopilar datos de la tabla visual (por si hubo ediciones inline)
                    const rows = tablaIrpfBody.querySelectorAll('tr');
                    const nuevosTramos = [];

                    rows.forEach(row => {
                        const desde = parseFloat(row.querySelector('.irpf-desde').value) || 0;
                        const hastaVal = row.querySelector('.irpf-hasta').value;
                        const hasta = hastaVal === '' ? null : parseFloat(hastaVal);
                        const porcentaje = parseFloat(row.querySelector('.irpf-porcentaje').value) || 0;

                        nuevosTramos.push({ desde, hasta, porcentaje });
                    });

                    // Validación básica
                    nuevosTramos.sort((a, b) => a.desde - b.desde);
                    tablasIrpf[anio] = nuevosTramos;

                    // Recopilar Mínimos Exentos
                    const nuevosParams = {
                        contribuyente: parseFloat(document.getElementById('irpf-min-contribuyente').value) || 0,
                        hijo1: parseFloat(document.getElementById('irpf-min-hijo1').value) || 0,
                        hijo2: parseFloat(document.getElementById('irpf-min-hijo2').value) || 0,
                        hijo3: parseFloat(document.getElementById('irpf-min-hijo3').value) || 0,
                        ascendiente: parseFloat(document.getElementById('irpf-min-ascendiente').value) || 0,
                        discapacidad: parseFloat(document.getElementById('irpf-min-discapacidad').value) || 0
                    };
                    parametrosIrpf[anio] = nuevosParams;

                    // GUARDAR AMBOS
                    try {
                        await Promise.all([
                            guardarConfigEnBD('tablas_irpf', tablasIrpf),
                            guardarConfigEnBD('parametros_irpf', parametrosIrpf)
                        ]);
                        showModal({ title: 'Éxito', message: 'Configuración IRPF (Tramos y Mínimos) guardada correctamente.' });
                    } catch (err) {
                        showModal({ title: 'Error', message: 'Error guardando config IRPF: ' + err.message });
                    }
                });
            }

            // Cargar al inicio (si estamos en admin)
            loadTablasIrpf();

            const listaDevengos = document.getElementById('lista-devengos');
            const listaDeducciones = document.getElementById('lista-deducciones');
            const formAddDevengo = document.getElementById('form-add-devengo');
            const formAddDeduccion = document.getElementById('form-add-deduccion');

            const renderConceptos = () => {
                listaDevengos.innerHTML = '';
                conceptos.devengos.forEach(nombre => {
                    const li = document.createElement('li');
                    li.className = 'flex justify-between items-center bg-gray-700 p-2 rounded';
                    li.innerHTML = `<span>${nombre}</span>
                            <button class="p-1 text-red-400 hover:text-red-200" onclick="app.borrarConcepto('devengos', '${nombre}')">
                                <i data-lucide="trash-2" class="w-4 h-4"></i>
                            </button>`;
                    listaDevengos.appendChild(li);
                });

                listaDeducciones.innerHTML = '';
                conceptos.deducciones.forEach(nombre => {
                    const li = document.createElement('li');
                    li.className = 'flex justify-between items-center bg-gray-700 p-2 rounded';
                    li.innerHTML = `<span>${nombre}</span>
                            <button class="p-1 text-red-400 hover:text-red-200" onclick="app.borrarConcepto('deducciones', '${nombre}')">
                                <i data-lucide="trash-2" class="w-4 h-4"></i>
                            </button>`;
                    listaDeducciones.appendChild(li);
                });
                lucide.createIcons();
            };

            // Añadir Devengo
            formAddDevengo.addEventListener('submit', async (e) => {
                e.preventDefault();
                const input = document.getElementById('new-devengo-name');
                const nombre = input.value.trim();
                if (nombre && !conceptos.devengos.includes(nombre)) {
                    conceptos.devengos.push(nombre);
                    await guardarConfigEnBD('conceptos', conceptos); // Guardar
                    renderConceptos();
                    input.value = '';
                }
            });

            // Añadir Deducción
            formAddDeduccion.addEventListener('submit', async (e) => {
                e.preventDefault();
                const input = document.getElementById('new-deduccion-name');
                const nombre = input.value.trim();
                if (nombre && !conceptos.deducciones.includes(nombre)) {
                    conceptos.deducciones.push(nombre);
                    await guardarConfigEnBD('conceptos', conceptos); // Guardar
                    renderConceptos();
                    input.value = '';
                }
            });

            // Borrar Concepto
            app.borrarConcepto = async (tipo, nombre) => {
                conceptos[tipo] = conceptos[tipo].filter(c => c !== nombre);
                await guardarConfigEnBD('conceptos', conceptos); // Guardar cambios
                renderConceptos();
            };

            // --- LÓGICA PARA EL FORMULARIO DE DATOS DE EMPRESA ---
            const formEmpresa = document.getElementById('form-empresa');

            const loadEmpresaData = () => {
                document.getElementById('empresa-nombre').value = empresa.nombre || '';
                document.getElementById('empresa-domicilio').value = empresa.domicilio || '';
                document.getElementById('empresa-cif').value = empresa.cif || '';
                document.getElementById('empresa-ccc').value = empresa.ccc || '';
            };

            formEmpresa.addEventListener('submit', async (e) => {
                e.preventDefault();
                empresa = {
                    nombre: document.getElementById('empresa-nombre').value,
                    domicilio: document.getElementById('empresa-domicilio').value,
                    cif: document.getElementById('empresa-cif').value,
                    ccc: document.getElementById('empresa-ccc').value,
                };

                // GUARDAR EN BD
                await guardarConfigEnBD('empresa', empresa);

                showModal({ title: 'Éxito', message: 'Datos de la empresa guardados en la base de datos.' });
            });

            // --- LÓGICA PARA GESTIONAR TIPOS DE CONTRATO ---
            const formAddContrato = document.getElementById('form-add-contrato');
            const listaContratos = document.getElementById('lista-contratos');

            const renderTiposContrato = () => {
                listaContratos.innerHTML = '';
                if (tiposContrato.length === 0 && tiposContrato.length === 0) {
                    // Sugerencia para añadir los primeros si la lista está vacía
                    tiposContrato.push('Indefinido', 'Temporal', 'Fijo-discontinuo', 'Formación y Aprendizaje', 'Prácticas');
                }

                tiposContrato.forEach(tipo => {
                    const li = document.createElement('li');
                    li.className = 'flex justify-between items-center bg-gray-700 p-2 rounded';
                    li.innerHTML = `<span>${tipo}</span>
                            <button class="p-1 text-red-400 hover:text-red-200" onclick="app.borrarTipoContrato('${tipo}')">
                                <i data-lucide="trash-2" class="w-4 h-4"></i>
                            </button>`;
                    listaContratos.appendChild(li);
                });
                lucide.createIcons();
            };

            formAddContrato.addEventListener('submit', async (e) => {
                e.preventDefault();
                const input = document.getElementById('new-contrato-name');
                const tipo = input.value.trim();
                if (tipo && !tiposContrato.includes(tipo)) {
                    tiposContrato.push(tipo);
                    await guardarConfigEnBD('contratos', tiposContrato); // Guardar
                    renderTiposContrato();
                    input.value = '';
                }
            });

            app.borrarTipoContrato = async (tipo) => {
                tiposContrato = tiposContrato.filter(t => t !== tipo);
                await guardarConfigEnBD('contratos', tiposContrato); // Guardar
                renderTiposContrato();
            };

            // --- LÓGICA PARA RELLENAR EL DROPDOWN DE CONTRATOS ---
            const renderTiposContratoDropdown = () => {
                const select = document.getElementById('empleado-tipo-contrato');
                const currentValue = select.value; // Guardar valor actual si se está editando
                select.innerHTML = '<option value="">-- Selecciona un tipo --</option>'; // Limpiar
                tiposContrato.forEach(tipo => {
                    const option = document.createElement('option');
                    option.value = tipo;
                    option.textContent = tipo;
                    select.appendChild(option);
                });
                select.value = currentValue; // Restaurar valor si existía
            };

            // --- LÓGICA PARA GESTIONAR USUARIOS ---
            const formAddUsuario = document.getElementById('form-add-usuario');
            const listaUsuarios = document.getElementById('lista-usuarios');
            const loggedInUser = sessionStorage.getItem('loggedInUser'); // Get current user

            const renderUsuariosList = () => {
                listaUsuarios.innerHTML = '';
                users.forEach(user => {
                    const li = document.createElement('li');
                    li.className = 'flex justify-between items-center bg-gray-700 p-2 rounded';
                    let deleteButtonHtml = '';
                    // Only allow deleting users other than 'admin'
                    if (user.username !== 'admin') {
                        deleteButtonHtml = `
                    <button class="p-1 text-red-400 hover:text-red-200" onclick="app.borrarUsuario('${user.username}')">
                        <i data-lucide="trash-2" class="w-4 h-4"></i>
                    </button>`;
                    }
                    li.innerHTML = `<span>${user.username}</span> ${deleteButtonHtml}`;
                    listaUsuarios.appendChild(li);
                });
                lucide.createIcons();
            };

            formAddUsuario.addEventListener('submit', async (e) => {
                e.preventDefault();
                const usernameInput = document.getElementById('new-username');
                const passwordInput = document.getElementById('new-password');
                const newUsername = usernameInput.value.trim();
                const newPassword = passwordInput.value;

                if (!newUsername || !newPassword) return;

                // Generar Hash en cliente (para mantener consistencia con auth.js)
                const newPasswordHash = CryptoJS.MD5(newPassword).toString();

                try {
                    const response = await fetch('/api/usuarios', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ username: newUsername, passwordHash: newPasswordHash })
                    });

                    const res = await response.json();
                    if (res.success) {
                        await loadDataFromDB(); // Recargar lista
                        usernameInput.value = '';
                        passwordInput.value = '';
                        showModal({ title: "Éxito", message: `Usuario '${newUsername}' añadido.` });
                    } else {
                        showModal({ title: "Error", message: res.error || "Error creando usuario." });
                    }
                } catch (err) { console.error(err); }
            });

            app.borrarUsuario = (usernameToDelete) => {
                if (usernameToDelete === 'admin') {
                    showModal({ title: "Error", message: "No se puede borrar el usuario administrador." });
                    return;
                }
                showModal({
                    title: 'Confirmar Borrado',
                    message: `¿Borrar usuario '${usernameToDelete}'?`,
                    type: 'confirm',
                    onConfirm: async () => {
                        try {
                            await fetch(`/api/usuarios/${usernameToDelete}`, { method: 'DELETE' });
                            await loadDataFromDB();
                        } catch (err) { console.error(err); }
                    }
                });
            };

            // ==========================================================
            // --- LÓGICA DE IMPORTAR/EXPORTAR DATOS ---
            // ==========================================================
            document.getElementById('exportar-datos').addEventListener('click', () => {
                const dataToExport = { puestos, empleados, configSS, conceptos, empresa, tiposContrato };
                const dataStr = JSON.stringify(dataToExport, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(dataBlob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `datos_nominas_${new Date().toISOString().slice(0, 10)}.json`;
                link.click();
                URL.revokeObjectURL(url);
            });

            const importFileInput = document.getElementById('import-file-input');
            const btnImportar = document.getElementById('importar-datos');

            if (btnImportar) {
                btnImportar.addEventListener('click', () => importFileInput.click());
            }

            importFileInput.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = JSON.parse(e.target.result);

                        // Verificamos que tenga una estructura mínima
                        if (data.puestos || data.empleados || data.configSS) {

                            showModal({
                                title: 'Confirmar Importación a la Nube',
                                message: 'Se van a subir estos datos a la base de datos. Este proceso puede tardar unos segundos. ¿Continuar?',
                                type: 'confirm',
                                onConfirm: async () => {
                                    // Feedback visual simple
                                    const originalText = btnImportar ? btnImportar.innerText : '';
                                    if (btnImportar) {
                                        btnImportar.innerText = "Subiendo datos... Espere";
                                        btnImportar.disabled = true;
                                    }

                                    try {
                                        // 1. IMPORTAR CONFIGURACIONES
                                        if (data.empresa) await fetch('/api/config/empresa', { method: 'POST', headers: { 'Content-Type': 'json' }, body: JSON.stringify(data.empresa) });
                                        if (data.configSS) await fetch('/api/config/ss', { method: 'POST', headers: { 'Content-Type': 'json' }, body: JSON.stringify(data.configSS) });
                                        if (data.conceptos) await fetch('/api/config/conceptos', { method: 'POST', headers: { 'Content-Type': 'json' }, body: JSON.stringify(data.conceptos) });
                                        if (data.tiposContrato) await fetch('/api/config/contratos', { method: 'POST', headers: { 'Content-Type': 'json' }, body: JSON.stringify(data.tiposContrato) });

                                        // 2. IMPORTAR PUESTOS (Uno a uno)
                                        if (Array.isArray(data.puestos)) {
                                            for (const puesto of data.puestos) {
                                                await fetch('/api/puestos', {
                                                    method: 'POST',
                                                    headers: { 'Content-Type': 'application/json' },
                                                    body: JSON.stringify(puesto)
                                                });
                                            }
                                        }

                                        // 3. IMPORTAR EMPLEADOS (Uno a uno)
                                        if (Array.isArray(data.empleados)) {
                                            for (const emp of data.empleados) {
                                                await fetch('/api/empleados', {
                                                    method: 'POST',
                                                    headers: { 'Content-Type': 'application/json' },
                                                    body: JSON.stringify(emp)
                                                });
                                            }
                                        }

                                        // 4. IMPORTAR USUARIOS (Opcional, saltando admin)
                                        const usuariosImportar = data.users || data.usuarios;
                                        if (Array.isArray(usuariosImportar)) {
                                            for (const u of usuariosImportar) {
                                                if (u.username !== 'admin') {
                                                    await fetch('/api/usuarios', {
                                                        method: 'POST',
                                                        headers: { 'Content-Type': 'application/json' },
                                                        body: JSON.stringify(u)
                                                    });
                                                }
                                            }
                                        }

                                        // Al terminar, recargamos los datos DE LA NUBE a la pantalla
                                        await loadDataFromDB();

                                        showModal({ title: 'Éxito', message: 'Datos migrados a la Base de Datos correctamente.' });

                                    } catch (err) {
                                        console.error(err);
                                        showModal({ title: 'Error', message: 'Hubo un fallo subiendo los datos: ' + err.message });
                                    } finally {
                                        if (btnImportar) {
                                            btnImportar.innerText = originalText || "Importar JSON";
                                            btnImportar.disabled = false;
                                        }
                                        importFileInput.value = '';
                                    }
                                }
                            });
                        } else {
                            showModal({ title: 'Error', message: 'El archivo no parece tener el formato correcto.' });
                        }
                    } catch (error) {
                        showModal({ title: 'Error', message: 'Error al leer el archivo JSON.' });
                    }
                };
                reader.readAsText(file);
            });

            // ==========================================================
            // LÓGICA DE AUTOCOMPLETADO DE BASE IT
            // ==========================================================
            const inputBajaInicio = document.getElementById('nomina-baja-inicio');
            const inputBaseAnterior = document.getElementById('nomina-base-mes-anterior');
            const suggestionContainer = document.getElementById('base-sugerencia-container');
            const suggestionText = document.getElementById('base-sugerencia-texto');

            const autocompletarBaseIT = async () => {
                const empleadoId = nominaEmpleadoSelect.value;
                const fechaBaja = inputBajaInicio.value;

                // Reset visual
                if (suggestionContainer) suggestionContainer.classList.add('hidden');

                if (!empleadoId || !fechaBaja) return;

                try {
                    const res = await fetch(`/api/nominas/base-anterior?empleadoId=${empleadoId}&fechaBaja=${fechaBaja}`);
                    if (res.ok) {
                        const data = await res.json();
                        if (data.base !== null) {
                            if (suggestionText) suggestionText.textContent = `💡 Base encontrada del mes pasado: ${data.base.toFixed(2)}€. Click para usar.`;
                            if (suggestionContainer) {
                                suggestionContainer.classList.remove('hidden');
                                // Click to apply
                                suggestionContainer.onclick = () => {
                                    inputBaseAnterior.value = data.base;
                                    suggestionContainer.classList.add('hidden');
                                };
                            }
                        }
                    }
                } catch (err) {
                    console.error("Error fetching base anterior:", err);
                }
            };

            if (inputBajaInicio) {
                inputBajaInicio.addEventListener('change', autocompletarBaseIT);
            }
            // Si cambiamos el empleado y ya hay fecha de baja, intentar buscar también
            if (nominaEmpleadoSelect) {
                nominaEmpleadoSelect.addEventListener('change', () => {
                    if (inputBajaInicio && inputBajaInicio.value) autocompletarBaseIT();
                });
            }


            // ==========================================================
            // --- LÓGICA DE GENERACIÓN DE NÓMINAS (UI) ---
            // ==========================================================
            const renderEmpleadosDropdownNomina = () => {
                nominaEmpleadoSelect.innerHTML = '<option value="">Selecciona un empleado...</option>';
                empleados.forEach(emp => {
                    const option = document.createElement('option');
                    option.value = emp.id;
                    option.textContent = emp.nombre;
                    nominaEmpleadoSelect.appendChild(option);
                });
            };

            // --- LÓGICA DE RECOMENDACIÓN DE IRPF ---
            const irpfSugeridoLabel = document.getElementById('irpf-sugerido-label');
            const btnAplicarIrpf = document.getElementById('btn-aplicar-irpf');

            const calcularIRPFRecomendado = (brutoMensual, pagas = 14, empleado = null) => {
                const anioActual = new Date().getFullYear().toString();

                // Cargar Tablas y Parámetros
                const tramos = tablasIrpf[anioActual] || tablasIrpf["2024"] || Object.values(tablasIrpf)[0] || [];
                const minParams = parametrosIrpf[anioActual] || {
                    contribuyente: 5550,
                    hijo1: 2400,
                    hijo2: 2700,
                    hijo3: 4000,
                    ascendiente: 1150,
                    discapacidad: 3000
                };

                if (tramos.length === 0) return null;

                const brutoAnual = brutoMensual * pagas;

                // --- PASO 1: Calcular Mínimo Personal y Familiar ---
                let minimoPersonalFamiliar = minParams.contribuyente;
                let infoFam = "Soltero/a sin cargas";

                if (empleado) {
                    const hijos = parseInt(empleado.hijos) || 0;
                    const ascendientes = parseInt(empleado.ascendientes) || 0;
                    const disc = parseFloat(empleado.discapacidad) || 0;

                    let totalHijos = 0;
                    if (hijos >= 1) totalHijos += minParams.hijo1;
                    if (hijos >= 2) totalHijos += minParams.hijo2;
                    if (hijos >= 3) totalHijos += (minParams.hijo3 * (hijos - 2));

                    const totalAsc = ascendientes * minParams.ascendiente;
                    const totalDisc = (disc >= 33) ? minParams.discapacidad : 0;
                    // Si es > 65% a veces se dobla, pero mantenemos simple segun prompt

                    minimoPersonalFamiliar += totalHijos + totalAsc + totalDisc;

                    if (hijos > 0 || ascendientes > 0 || disc > 0) {
                        infoFam = `${hijos} hijos, ${ascendientes} asc., Disc. ${disc}%`;
                    }
                }

                // --- PASO 2: Función auxiliar cálculo cuota ---
                const calcularCuota = (base, _tramos) => {
                    let cuota = 0;
                    // Asegurar orden
                    const tramosOrdenados = [..._tramos].sort((a, b) => a.desde - b.desde);

                    for (const t of tramosOrdenados) {
                        const limiteInferior = t.desde;
                        const limiteSuperior = t.hasta || Infinity;
                        const porcentaje = t.porcentaje;

                        if (base > limiteInferior) {
                            const baseImponibleTramo = Math.min(base, limiteSuperior) - limiteInferior;
                            cuota += baseImponibleTramo * (porcentaje / 100);
                        }
                    }
                    return cuota;
                };

                // --- PASO 3: Calcular Cuota 1 (Sobre Bruto) y Cuota 2 (Sobre Mínimo) ---
                const cuota1 = calcularCuota(brutoAnual, tramos);
                const cuota2 = calcularCuota(minimoPersonalFamiliar, tramos);

                // --- PASO 4: Cuota Líquida ---
                const cuotaLiquida = Math.max(0, cuota1 - cuota2);

                // --- PASO 5: Tipo Medio ---
                const tipoMedio = (cuotaLiquida / brutoAnual) * 100;

                return {
                    tipo: tipoMedio > 0 ? tipoMedio.toFixed(2) : "0.00",
                    c1: cuota1.toFixed(2),
                    c2: cuota2.toFixed(2),
                    minimo: minimoPersonalFamiliar,
                    info: infoFam
                };
            };

            const otrosDevengosContainer = document.getElementById('otros-devengos-container');
            const addDevengoBtn = document.getElementById('add-devengo-btn');
            const otrasDeduccionesContainer = document.getElementById('otras-deducciones-container');
            const addDeduccionBtn = document.getElementById('add-deduccion-btn');
            const selectDevengo = document.getElementById('select-devengo');
            const selectDeduccion = document.getElementById('select-deduccion');

            // --- Elementos Nómina LOTE (NUEVOS) ---
            const formNominaLote = document.getElementById('form-nomina-lote');
            const nominaListaEmpleadosLote = document.getElementById('nomina-lista-empleados-lote');
            const selectAllCheckboxLote = document.getElementById('seleccionar-todos-empleados-lote');
            const nominaFechaInicioLote = document.getElementById('nomina-fecha-inicio-lote');
            const nominaFechaFinLote = document.getElementById('nomina-fecha-fin-lote');
            const nominaIrpfLote = document.getElementById('nomina-irpf-lote');
            const selectDevengoLote = document.getElementById('select-devengo-lote');
            const addDevengoLoteBtn = document.getElementById('add-devengo-lote-btn');
            const otrosDevengosLoteContainer = document.getElementById('otros-devengos-lote-container');
            const selectDeduccionLote = document.getElementById('select-deduccion-lote');
            const addDeduccionLoteBtn = document.getElementById('add-deduccion-lote-btn');
            const otrasDeduccionesLoteContainer = document.getElementById('otras-deducciones-lote-container');
            const nominaLoteResultadoContainer = document.getElementById('nomina-lote-resultado-container');
            const nominaLoteResultadoDiv = document.getElementById('nomina-lote-resultado');
            const btnExportarLoteCsv = document.getElementById('btn-exportar-lote-csv');

            let ultimoCalculo = null;

            // --- ESTADO PARA DATOS ESPECÍFICOS DE LOTE ---
            let batchEmployeeData = {}; // { empId: { bajaInicio, bajaFin, baseAnterior, irpf, devengos: [], deducciones: [] } }

            const renderConceptoDropdowns = () => {
                selectDevengo.innerHTML = '<option value="_manual_">-- Añadir concepto manual --</option>';
                conceptos.devengos.forEach(c => {
                    selectDevengo.innerHTML += `<option value="${c}">${c}</option>`;
                });

                selectDeduccion.innerHTML = '<option value="_manual_">-- Añadir concepto manual --</option>';
                conceptos.deducciones.forEach(c => {
                    selectDeduccion.innerHTML += `<option value="${c}">${c}</option>`;
                });
            };

            const createConceptoRow = (type, conceptoNombre = '') => {
                const div = document.createElement('div');
                div.className = 'flex items-center space-x-2';
                const isManual = conceptoNombre === '';

                div.innerHTML = `
            ${isManual
                        ? `<input type="text" class="w-full form-input p-1 text-sm ${type}-concepto" placeholder="Concepto">`
                        : `<span class="w-full p-1 text-sm ${type}-concepto">${conceptoNombre}</span>`
                    }
            <input type="number" step="0.01" class="w-2/5 form-input p-1 text-sm ${type}-importe" placeholder="0.00">
            <button type="button" class="p-1 text-red-500 hover:text-red-300 remove-concepto-btn">
                <i data-lucide="x-circle" class="w-4 h-4"></i>
            </button>
        `;
                lucide.createIcons({
                    nodes: [div.querySelector('.remove-concepto-btn')]
                });
                return div;
            };

            addDevengoBtn.addEventListener('click', () => {
                const conceptoSeleccionado = selectDevengo.value;
                if (conceptoSeleccionado === '_manual_') {
                    otrosDevengosContainer.appendChild(createConceptoRow('devengo'));
                } else {
                    otrosDevengosContainer.appendChild(createConceptoRow('devengo', conceptoSeleccionado));
                }
            });

            addDeduccionBtn.addEventListener('click', () => {
                const conceptoSeleccionado = selectDeduccion.value;
                if (conceptoSeleccionado === '_manual_') {
                    otrasDeduccionesContainer.appendChild(createConceptoRow('deduccion'));
                } else {
                    otrasDeduccionesContainer.appendChild(createConceptoRow('deduccion', conceptoSeleccionado));
                }
            });

            formNomina.addEventListener('click', (e) => {
                const removeBtn = e.target.closest('.remove-concepto-btn');
                if (removeBtn) {
                    removeBtn.parentElement.remove();
                }
            });





            // --- NUEVO: Listener para resetear el formulario al cambiar de empleado ---
            nominaEmpleadoSelect.addEventListener('change', () => {
                setDefaultNominaDates();
                
                // Limpieza segura de campos
                const idsALimpiar = ['nomina-baja-inicio', 'nomina-baja-fin', 'otros-devengos-container', 'otras-deducciones-container', 'nomina-resultado'];
                idsALimpiar.forEach(id => {
                    const el = document.getElementById(id);
                    if (el) (el.value !== undefined ? el.value = '' : el.innerHTML = '');
                });

                const inputIrpf = document.getElementById('nomina-irpf');
                if (inputIrpf) inputIrpf.value = '0.00';

                if (nominaResultadoContainer) nominaResultadoContainer.classList.add('hidden');

                // --- CORRECCIÓN ERROR btnAplicarIrpf ---
                const irpfSugeridoLabel = document.getElementById('irpf-sugerido-label');
                const btnAplicarIrpf = document.getElementById('btn-aplicar-irpf');
                
                // Reset visual inicial
                if (irpfSugeridoLabel) irpfSugeridoLabel.textContent = "";
                if (btnAplicarIrpf) btnAplicarIrpf.style.display = 'none';

                const empId = nominaEmpleadoSelect.value;
                if (empId) {
                    const emp = empleados.find(e => e.id === empId);
                    const puesto = puestos.find(p => p.id === emp?.puestoId);
                    
                    // Solo calculamos si tenemos la función disponible
                    if (puesto && typeof calcularIRPFRecomendado === 'function') {
                        const resIrpf = calcularIRPFRecomendado(parseFloat(puesto.salario), 14, emp);
                        if (resIrpf) {
                            if (irpfSugeridoLabel) {
                                irpfSugeridoLabel.innerHTML = `Sugerido: <strong>${resIrpf.tipo}%</strong>`;
                            }
                            if (btnAplicarIrpf) btnAplicarIrpf.style.display = 'inline-block';
                        }
                    }
                }
            });

            // Elementos Modo Manual
            const manualModeToggle = document.getElementById('manual-mode-toggle');
            const manualModeFields = document.getElementById('manual-mode-fields');
            const fieldsetBaja = document.getElementById('fieldset-baja'); // Asegúrate de que este ID exista en el HTML

            // Toggle Modo Manual
            if (manualModeToggle) {
                manualModeToggle.addEventListener('change', (e) => {
                    if (e.target.checked) {
                        manualModeFields.classList.remove('hidden');
                        if (fieldsetBaja) fieldsetBaja.classList.add('opacity-50', 'pointer-events-none');
                    } else {
                        manualModeFields.classList.add('hidden');
                        if (fieldsetBaja) fieldsetBaja.classList.remove('opacity-50', 'pointer-events-none');
                    }
                });
            }

            formNomina.addEventListener('submit', (e) => {
                e.preventDefault();
                const empleadoId = nominaEmpleadoSelect.value;
                const fechaInicio = document.getElementById('nomina-fecha-inicio').value;
                const fechaFin = document.getElementById('nomina-fecha-fin').value;
                const fechaInicioBaja = document.getElementById('nomina-baja-inicio').value;
                const fechaFinBaja = document.getElementById('nomina-baja-fin').value;
                const baseMesAnterior = document.getElementById('nomina-base-mes-anterior').value;
                // Calculamos IRPF Sugerido al cambiar de empleado (ver listener select)
                const porcentajeIRPF = document.getElementById('nomina-irpf').value;

                const otrosDevengos = Array.from(document.querySelectorAll('#otros-devengos-container .flex')).map(row => ({
                    concepto: row.querySelector('.devengo-concepto').value || row.querySelector('.devengo-concepto').textContent,
                    importe: parseFloat(row.querySelector('.devengo-importe').value) || 0
                }));

                const otrasDeducciones = Array.from(document.querySelectorAll('#otras-deducciones-container .flex')).map(row => ({
                    concepto: row.querySelector('.deduccion-concepto').value || row.querySelector('.deduccion-concepto').textContent,
                    importe: parseFloat(row.querySelector('.deduccion-importe').value) || 0
                }));

                if (!empleadoId) {
                    showModal({ title: "Error", message: "Por favor, selecciona un empleado." });
                    return;
                }

                const empleado = empleados.find(emp => emp.id === empleadoId);
                const puesto = puestos.find(p => p.id === empleado.puestoId);

                // Datos Manuales
                let manualData = null;
                if (manualModeToggle && manualModeToggle.checked) {
                    manualData = {
                        salarioBase: parseFloat(document.getElementById('manual-salario-base').value) || 0,
                        prorrata: parseFloat(document.getElementById('manual-prorrata').value) || 0,
                        plusConvenio: parseFloat(document.getElementById('manual-plus-convenio').value) || 0,
                        baseCotizacion: parseFloat(document.getElementById('manual-base-cotizacion').value) || 0,
                        prestacionBaja: parseFloat(document.getElementById('manual-prestacion-baja').value) || 0,
                        complementoBaja: parseFloat(document.getElementById('manual-complemento-baja').value) || 0
                    };
                }

                const nominaCalculada = calcularNomina(empleado, puesto, configSS, fechaInicio, fechaFin, fechaInicioBaja, fechaFinBaja, porcentajeIRPF, otrosDevengos, otrasDeducciones, baseMesAnterior, manualData);

                if (nominaCalculada.error) {
                    showModal({ title: "Error de Cálculo", message: nominaCalculada.error });
                    nominaResultadoContainer.classList.add('hidden');
                } else {
                    ultimaNominaCalculada = {
                        nomina: nominaCalculada,
                        empleado: empleado,
                        periodo: { inicio: fechaInicio, fin: fechaFin }
                    };
                    displayNominaResult(nominaCalculada, empleado);
                }
            });

            const displayNominaResult = (nomina, empleado) => {
                let otrosDevengosHtml = '';
                if (nomina.otrosDevengos && nomina.otrosDevengos.length > 0) {
                    nomina.otrosDevengos.forEach(d => {
                        if (parseFloat(d.importe) > 0) {
                            otrosDevengosHtml += `<dt>${d.concepto || 'Otro Devengo'}</dt><dd>${d.importe} €</dd>`;
                        }
                    });
                }

                // --- NUEVO: Generar HTML para los conceptos de antigüedad dinámicos ---
                let conceptosCalculadosHtml = '';
                if (nomina.conceptosCalculados && nomina.conceptosCalculados.length > 0) {
                    conceptosCalculadosHtml = nomina.conceptosCalculados.map(c =>
                        `<dt>${c.nombre || c.concepto} ${c.periodos ? `(${c.periodos})` : ''}</dt><dd>${c.importe} €</dd>`
                    ).join('');
                }

                let otrasDeduccionesHtml = '';
                if (nomina.otrasDeducciones && nomina.otrasDeducciones.length > 0) {
                    nomina.otrasDeducciones.forEach(d => {
                        if (parseFloat(d.importe) > 0) {
                            otrasDeduccionesHtml += `<dt>&nbsp;&nbsp;&nbsp;${d.concepto || 'Otra Deducción'}</dt><dd>${d.importe} €</dd>`;
                        }
                    });
                }

                nominaResultadoDiv.innerHTML = `
            <p class="text-lg font-semibold text-white mb-4">Nómina de ${empleado.nombre}</p>
            <div class="space-y-6">
                <div>
                    <h4 class="font-semibold text-blue-400 mb-2 border-b border-gray-600 pb-1">I. DEVENGOS</h4>
                    <dl class="nomina-result-grid">
                        <dt>Salario Base (${nomina.diasTrabajados} días)</dt><dd>${nomina.salarioBasePeriodo} €</dd>
                        <dt>Prorrata Pagas Extra</dt><dd>${nomina.prorrataExtraPeriodo} €</dd>
                        
                        ${conceptosCalculadosHtml}

                        ${otrosDevengosHtml}
                        ${nomina.complementoEnfermedadEmpresa > 0 ? `<dt>Complemento Empresa por Baja</dt><dd>${nomina.complementoEnfermedadEmpresa} €</dd>` : ''}
                        ${nomina.diasBajaEnPeriodo > 0 ? `<dt>Prestación por Baja (${nomina.diasBajaEnPeriodo} días)</dt><dd>${nomina.prestacionEnfermedadLegal} €</dd>` : ''}
                        <dt class="border-t border-gray-600 pt-2 mt-2 font-bold text-gray-200">A. TOTAL DEVENGADO</dt>
                        <dd class="border-t border-gray-600 pt-2 mt-2 font-bold text-gray-200">${nomina.totalDevengos} €</dd>
                    </dl>
                </div>
                <div>
                    <h4 class="font-semibold text-blue-400 mb-2 border-b border-gray-600 pb-1">II. DEDUCCIONES</h4>
                    <dl class="nomina-result-grid">
                        <dt>Base de Cotización</dt><dd>${nomina.baseCotizacion} €</dd>
                        <dt class="col-span-2 text-gray-400 text-sm pt-2">Aportaciones del trabajador a la S.S.</dt>
                        <dt>&nbsp;&nbsp;&nbsp;Contingencias Comunes (${nomina.porcCC}%)</dt><dd>${nomina.deduccionCC} €</dd>
                        <dt>&nbsp;&nbsp;&nbsp;Desempleo (${nomina.porcDesempleo}%)</dt><dd>${nomina.deduccionDesempleo} €</dd>
                        <dt>&nbsp;&nbsp;&nbsp;Formación Profesional (${nomina.porcFP}%)</dt><dd>${nomina.deduccionFP} €</dd>
                        <dt>&nbsp;&nbsp;&nbsp;MEI (${nomina.porcMEI}%)</dt><dd>${nomina.deduccionMEI} €</dd>
                        <dt class="col-span-2 text-gray-400 text-sm pt-2">Otras Deducciones</dt>
                        <dt>&nbsp;&nbsp;&nbsp;IRPF (${nomina.porcentajeIRPF}%)</dt><dd>${nomina.deduccionIRPF} €</dd>
                        ${otrasDeduccionesHtml}
                        <dt class="border-t border-gray-600 pt-2 mt-2 font-bold text-gray-200">B. TOTAL A DEDUCIR</dt>
                        <dd class="border-t border-gray-600 pt-2 mt-2 font-bold text-gray-200">${nomina.totalDeducciones} €</dd>
                    </dl>
                </div>
                <div class="border-t-2 border-blue-400 pt-4">
                    <dl class="nomina-result-grid text-lg">
                        <dt class="font-bold text-gray-200">LÍQUIDO TOTAL A PERCIBIR (A-B)</dt>
                        <dd class="font-bold text-green-400">${nomina.salarioNeto} €</dd>
                    </dl>
                </div>
            </div>
        `;
                nominaResultadoContainer.classList.remove('hidden');
                document.getElementById('btn-exportar-nomina').style.display = 'inline-flex';
                if (btnGuardarIndividualBd) btnGuardarIndividualBd.style.display = 'inline-flex';
                document.getElementById('btn-exportar-pdf').style.display = 'inline-flex';
                lucide.createIcons();
            };

            // --- LÓGICA PARA LA SELECCIÓN MÚLTIPLE DE EMPLEADOS (LOTE) ---
            const renderEmployeeSelectionListLote = () => {
                if (!nominaListaEmpleadosLote || !selectAllCheckboxLote) return;
                nominaListaEmpleadosLote.innerHTML = '';

                empleados.forEach(emp => {
                    const div = document.createElement('div');
                    div.className = 'employee-batch-item border border-gray-700 rounded-lg p-3 mb-2 bg-gray-800 flex items-center justify-between';
                    div.dataset.empId = emp.id;

                    // Check if this employee has custom data
                    const hasCustomData = batchEmployeeData[emp.id] && (
                        batchEmployeeData[emp.id].bajaInicio ||
                        batchEmployeeData[emp.id].irpf ||
                        (batchEmployeeData[emp.id].devengos && batchEmployeeData[emp.id].devengos.length > 0) ||
                        (batchEmployeeData[emp.id].deducciones && batchEmployeeData[emp.id].deducciones.length > 0)
                    );

                    div.innerHTML = `
                <div class="flex items-center">
                    <input type="checkbox" id="emp-lote-${emp.id}" name="nomina_empleados_lote" value="${emp.id}" class="mr-3 h-5 w-5 rounded bg-gray-700 border-gray-500 text-blue-600 focus:ring-blue-500">
                    <div>
                        <label for="emp-lote-${emp.id}" class="text-sm font-medium text-gray-200 cursor-pointer select-none block">${emp.nombre}</label>
                        ${hasCustomData ? '<span class="text-xs text-blue-400 flex items-center mt-1"><i data-lucide="check-circle" class="w-3 h-3 mr-1"></i> Datos personalizados</span>' : ''}
                    </div>
                </div>
                <button type="button" class="btn btn-secondary text-xs py-1 px-3 open-batch-modal-btn">
                    <i data-lucide="settings-2" class="w-4 h-4 mr-2"></i> Detalles
                </button>
            `;
                    nominaListaEmpleadosLote.appendChild(div);
                });
                lucide.createIcons();

                selectAllCheckboxLote.onchange = (e) => {
                    const checkboxes = document.querySelectorAll('input[name="nomina_empleados_lote"]');
                    checkboxes.forEach(checkbox => checkbox.checked = e.target.checked);
                };
            };

            // --- LÓGICA DEL MODAL DE LOTE ---
            const batchModalOverlay = document.getElementById('batch-employee-modal-overlay');
            const batchModalTitle = document.getElementById('batch-modal-title');
            const batchModalEmpId = document.getElementById('batch-modal-emp-id');
            const batchModalExcludeCommon = document.getElementById('batch-modal-exclude-common');
            const batchModalBajaInicio = document.getElementById('batch-modal-baja-inicio');
            const batchModalBajaFin = document.getElementById('batch-modal-baja-fin');
            const batchModalBaseAnterior = document.getElementById('batch-modal-base-anterior');
            const batchModalIrpf = document.getElementById('batch-modal-irpf');
            const batchModalDevengoSelect = document.getElementById('batch-modal-devengo-select');
            const batchModalAddDevengoBtn = document.getElementById('batch-modal-add-devengo-btn');
            const batchModalDevengosList = document.getElementById('batch-modal-devengos-list');
            const batchModalDeduccionSelect = document.getElementById('batch-modal-deduccion-select');
            const batchModalAddDeduccionBtn = document.getElementById('batch-modal-add-deduccion-btn');
            const batchModalDeduccionesList = document.getElementById('batch-modal-deducciones-list');
            const batchModalCancelBtn = document.getElementById('batch-modal-cancel-btn');
            const batchModalSaveBtn = document.getElementById('batch-modal-save-btn');

            // Variables temporales para el modal
            let tempBatchDevengos = [];
            let tempBatchDeducciones = [];

            const openBatchEmployeeModal = (empId) => {
                try {
                    const emp = empleados.find(e => e.id === empId);
                    if (!emp) return;

                    batchModalEmpId.value = empId;
                    batchModalTitle.textContent = `Detalles: ${emp.nombre}`;

                    // Cargar datos existentes o defaults
                    const data = batchEmployeeData[empId] || {};
                    if (batchModalExcludeCommon) {
                        batchModalExcludeCommon.checked = data.excludeCommon || false;
                    }
                    if (batchModalBajaInicio) batchModalBajaInicio.value = data.bajaInicio || '';
                    if (batchModalBajaFin) batchModalBajaFin.value = data.bajaFin || '';
                    if (batchModalBaseAnterior) batchModalBaseAnterior.value = data.baseAnterior || '';
                    if (batchModalIrpf) batchModalIrpf.value = data.irpf || '';

                    tempBatchDevengos = [...(data.devengos || [])];
                    tempBatchDeducciones = [...(data.deducciones || [])];

                    // Poblar selects
                    if (batchModalDevengoSelect) {
                        batchModalDevengoSelect.innerHTML = '<option value="">-- Selecciona --</option>' +
                            (conceptos.devengos || []).map(c => `<option value="${c}">${c}</option>`).join('') +
                            '<option value="_manual_">-- Manual --</option>';
                    }

                    if (batchModalDeduccionSelect) {
                        batchModalDeduccionSelect.innerHTML = '<option value="">-- Selecciona --</option>' +
                            (conceptos.deducciones || []).map(c => `<option value="${c}">${c}</option>`).join('') +
                            '<option value="_manual_">-- Manual --</option>';
                    }

                    renderBatchModalLists();
                    if (batchModalOverlay) batchModalOverlay.classList.remove('hidden');
                } catch (error) {
                    console.error("Error opening modal:", error);
                    alert("Error al abrir el modal: " + error.message);
                }
            };

            const renderBatchModalLists = () => {
                batchModalDevengosList.innerHTML = '';
                tempBatchDevengos.forEach((item, index) => {
                    const div = document.createElement('div');
                    div.className = 'flex items-center space-x-2 bg-gray-700 p-2 rounded';
                    div.innerHTML = `
                <span class="flex-1 text-sm text-gray-200">${item.concepto}</span>
                <span class="text-sm font-mono text-blue-300">${item.importe.toFixed(2)} €</span>
                <button type="button" class="text-red-400 hover:text-red-200" onclick="removeBatchModalItem('devengo', ${index})">
                    <i data-lucide="trash-2" class="w-4 h-4"></i>
                </button>
            `;
                    batchModalDevengosList.appendChild(div);
                });

                batchModalDeduccionesList.innerHTML = '';
                tempBatchDeducciones.forEach((item, index) => {
                    const div = document.createElement('div');
                    div.className = 'flex items-center space-x-2 bg-gray-700 p-2 rounded';
                    div.innerHTML = `
                <span class="flex-1 text-sm text-gray-200">${item.concepto}</span>
                <span class="text-sm font-mono text-blue-300">${item.importe.toFixed(2)} €</span>
                <button type="button" class="text-red-400 hover:text-red-200" onclick="removeBatchModalItem('deduccion', ${index})">
                    <i data-lucide="trash-2" class="w-4 h-4"></i>
                </button>
            `;
                    batchModalDeduccionesList.appendChild(div);
                });
                lucide.createIcons();
            };

            // Helper global para onclick en HTML generado dinámicamente
            window.removeBatchModalItem = (type, index) => {
                if (type === 'devengo') tempBatchDevengos.splice(index, 1);
                else tempBatchDeducciones.splice(index, 1);
                renderBatchModalLists();
            };

            const addBatchModalItem = (type) => {
                const select = type === 'devengo' ? batchModalDevengoSelect : batchModalDeduccionSelect;
                const amountInput = type === 'devengo' ? document.getElementById('batch-modal-devengo-amount') : document.getElementById('batch-modal-deduccion-amount');

                const val = select.value;
                if (!val) {
                    alert("Selecciona un concepto");
                    return;
                }

                let concepto = val;
                if (val === '_manual_') {
                    concepto = prompt("Introduce el nombre del concepto:");
                    if (!concepto) return;
                }

                const importe = parseFloat(amountInput.value);

                if (isNaN(importe)) {
                    alert("Introduce un importe válido");
                    return;
                }

                const newItem = { concepto, importe };
                if (type === 'devengo') tempBatchDevengos.push(newItem);
                else tempBatchDeducciones.push(newItem);

                select.value = '';
                amountInput.value = ''; // Limpiar input
                renderBatchModalLists();
            };

            batchModalAddDevengoBtn?.addEventListener('click', (e) => { e.preventDefault(); addBatchModalItem('devengo'); });
            batchModalAddDeduccionBtn?.addEventListener('click', (e) => { e.preventDefault(); addBatchModalItem('deduccion'); });

            batchModalCancelBtn.addEventListener('click', () => {
                batchModalOverlay.classList.add('hidden');
            });

            batchModalSaveBtn.addEventListener('click', () => {
                const empId = batchModalEmpId.value;
                if (!empId) return;

                batchEmployeeData[empId] = {
                    excludeCommon: batchModalExcludeCommon.checked,
                    bajaInicio: batchModalBajaInicio.value,
                    bajaFin: batchModalBajaFin.value,
                    baseAnterior: batchModalBaseAnterior.value,
                    irpf: batchModalIrpf.value,
                    devengos: tempBatchDevengos,
                    deducciones: tempBatchDeducciones
                };

                batchModalOverlay.classList.add('hidden');
                renderEmployeeSelectionListLote(); // Re-render to show indicators
            });

            // Delegación para abrir el modal (Global para asegurar que funcione tras re-render)
            document.addEventListener('click', (e) => {
                const btn = e.target.closest('.open-batch-modal-btn');
                if (btn) {
                    e.preventDefault(); // Evitar cualquier comportamiento por defecto (submit, etc.)
                    e.stopPropagation(); // Evitar propagación
                    const empId = btn.closest('.employee-batch-item').dataset.empId;
                    openBatchEmployeeModal(empId);
                }
            });

            // --- LÓGICA PARA LOS DESPLEGABLES DE CONCEPTOS DEL LOTE ---
            const renderConceptoDropdownsLote = () => {
                if (!selectDevengoLote || !selectDeduccionLote) return; // Comprobación
                selectDevengoLote.innerHTML = '<option value="">-- Selecciona Devengo Común --</option>';
                selectDeduccionLote.innerHTML = '<option value="">-- Selecciona Deducción Común --</option>';
                (conceptos.devengos || []).forEach(c => {
                    const option = document.createElement('option');
                    option.value = c; option.textContent = c;
                    selectDevengoLote.appendChild(option);
                });
                (conceptos.deducciones || []).forEach(c => {
                    const option = document.createElement('option');
                    option.value = c; option.textContent = c;
                    selectDeduccionLote.appendChild(option);
                });
            };

            // --- LÓGICA PARA AÑADIR/QUITAR CONCEPTOS COMUNES DEL LOTE ---
            const addConceptoComunLote = (tipo) => {
                const select = (tipo === 'devengo') ? selectDevengoLote : selectDeduccionLote;
                const container = (tipo === 'devengo') ? otrosDevengosLoteContainer : otrasDeduccionesLoteContainer;
                if (!select || !container) return; // Comprobación

                const conceptoNombre = select.value;
                if (!conceptoNombre) return;

                const yaExiste = Array.from(container.children).some(div => div.dataset.concepto === conceptoNombre);
                if (yaExiste) return;

                const div = document.createElement('div');
                div.className = 'flex items-center space-x-2 bg-gray-700 p-1 rounded text-sm';
                div.dataset.concepto = conceptoNombre;
                div.innerHTML = `
            <span class="w-full ${tipo}-concepto">${conceptoNombre}</span>
            <input type="number" step="0.01" class="w-2/5 form-input p-1 text-sm ${tipo}-importe-lote" placeholder="0.00" required> <button type="button" class="p-1 text-red-500 hover:text-red-300 remove-concepto-lote-btn"> <i data-lucide="x-circle" class="w-4 h-4"></i>
            </button>
        `;
                container.appendChild(div);
                lucide.createIcons({ nodes: [div.querySelector('.remove-concepto-lote-btn')] });
                select.selectedIndex = 0;
            };

            // --- Listeners para Lote ---
            addDevengoLoteBtn?.addEventListener('click', () => addConceptoComunLote('devengo'));
            addDeduccionLoteBtn?.addEventListener('click', () => addConceptoComunLote('deduccion'));

            otrosDevengosLoteContainer?.addEventListener('click', (e) => {
                if (e.target.closest('.remove-concepto-lote-btn')) e.target.closest('div').remove();
            });
            otrasDeduccionesLoteContainer?.addEventListener('click', (e) => {
                if (e.target.closest('.remove-concepto-lote-btn')) e.target.closest('div').remove();
            });

            // --- Listener Principal del Formulario de Lote ---
            formNominaLote?.addEventListener('submit', (e) => {
                e.preventDefault();

                // Obtenemos los checkboxes seleccionados
                const checkboxes = Array.from(document.querySelectorAll('input[name="nomina_empleados_lote"]:checked'));
                if (checkboxes.length === 0) {
                    showModal({ title: "Error", message: "Selecciona al menos un empleado." });
                    return;
                }

                const fechaInicio = nominaFechaInicioLote.value;
                const fechaFin = nominaFechaFinLote.value;
                const porcentajeIRPFGeneral = nominaIrpfLote.value;

                // Recopilar devengos/deducciones comunes del formulario de lote
                const devengosComunes = Array.from(otrosDevengosLoteContainer.children).map(div => ({
                    concepto: div.dataset.concepto,
                    importe: parseFloat(div.querySelector('.devengo-importe-lote').value) || 0
                }));
                const deduccionesComunes = Array.from(otrasDeduccionesLoteContainer.children).map(div => ({
                    concepto: div.dataset.concepto,
                    importe: parseFloat(div.querySelector('.deduccion-importe-lote').value) || 0
                }));

                const resultados = [];
                let huboErrores = false;

                checkboxes.forEach(cb => {
                    const id = cb.value;
                    const empleado = empleados.find(emp => emp.id === id);
                    const puesto = puestos.find(p => p.id === empleado?.puestoId);

                    if (!empleado || !puesto) {
                        resultados.push({ empleado: { nombre: `ID ${id} no encontrado` }, nomina: { error: "Empleado o puesto no encontrado." } });
                        huboErrores = true;
                        return;
                    }

                    // --- Extracción de Datos Específicos desde batchEmployeeData ---
                    const data = batchEmployeeData[id] || {};

                    const excludeCommon = data.excludeCommon || false;
                    const fechaInicioBaja = data.bajaInicio || null;
                    const fechaFinBaja = data.bajaFin || null;
                    const baseMesAnterior = data.baseAnterior || null;

                    const irpfEspecifico = data.irpf;
                    const porcentajeIRPF = irpfEspecifico && irpfEspecifico !== '' ? irpfEspecifico : porcentajeIRPFGeneral;

                    // Devengos Específicos
                    const devengosEspecificos = data.devengos || [];

                    // Deducciones Específicas
                    const deduccionesEspecificas = data.deducciones || [];

                    // Combinar Comunes + Específicos (Respetando el flag excludeCommon)
                    const todosDevengos = excludeCommon ? [...devengosEspecificos] : [...devengosComunes, ...devengosEspecificos];
                    const todasDeducciones = excludeCommon ? [...deduccionesEspecificas] : [...deduccionesComunes, ...deduccionesEspecificas];

                    // Llamamos a calcularNomina con los datos combinados
                    const nominaCalculada = calcularNomina(empleado, puesto, configSS, fechaInicio, fechaFin, fechaInicioBaja, fechaFinBaja, porcentajeIRPF, todosDevengos, todasDeducciones, baseMesAnterior);

                    if (nominaCalculada.error) {
                        huboErrores = true;
                    }
                    resultados.push({ empleado, puesto, nomina: nominaCalculada, periodo: { inicio: fechaInicio, fin: fechaFin } });
                });

                if (huboErrores) {
                    showModal({ title: "Atención", message: "Se produjeron errores en el cálculo de algunas nóminas." });
                }

                ultimoCalculo = resultados; // Guardamos el array de resultados
                displayBatchNominaResults(resultados);
            });

            // --- Función para Mostrar Resultados del Lote ---
            const displayBatchNominaResults = (resultados) => {
                if (!nominaLoteResultadoDiv || !nominaLoteResultadoContainer || !btnExportarLoteCsv) return; // Comprobación

                let tableHTML = `<div class="overflow-x-auto"><table class="w-full data-table"><thead><tr>
                           <th>Empleado</th><th>Total Devengado</th><th>Total Deducido</th><th>Líquido</th><th>Estado</th><th>Acciones</th>
                         </tr></thead><tbody>`;

                resultados.forEach((res, index) => {
                    const { empleado, nomina } = res;
                    if (nomina.error) {
                        tableHTML += `<tr class="bg-red-900 bg-opacity-30"><td>${empleado.nombre}</td>
                              <td colspan="3" class="text-center text-red-400">${nomina.error}</td>
                              <td><span class="px-2 py-1 text-xs font-semibold text-red-100 bg-red-600 rounded-full">Error</span></td>
                              <td></td></tr>`;
                    } else {
                        tableHTML += `<tr><td>${empleado.nombre}</td><td>${nomina.totalDevengos} €</td><td>${nomina.totalDeducciones} €</td>
                               <td class="font-semibold text-green-400">${nomina.salarioNeto} €</td>
                               <td><span class="px-2 py-1 text-xs font-semibold text-green-100 bg-green-600 rounded-full">OK</span></td>
                               <td>
                                   <button class="btn btn-secondary text-xs py-1 px-2 btn-ver-detalle-lote" data-index="${index}">
                                       <i data-lucide="eye" class="w-4 h-4 mr-1"></i> Ver Detalle
                                   </button>
                               </td></tr>`;
                    }
                });
                tableHTML += `</tbody></table></div>`;

                nominaLoteResultadoDiv.innerHTML = tableHTML;
                nominaLoteResultadoContainer.classList.remove('hidden');
                btnExportarLoteCsv.style.display = 'inline-flex';
                if (btnGuardarLoteBd) btnGuardarLoteBd.style.display = 'inline-flex';
                document.getElementById('btn-exportar-lote-pdf').style.display = 'inline-flex';
                lucide.createIcons();
            };

            // ==========================================================
            // --- LÓGICA DE HISTORIAL ---
            // ==========================================================
            const tablaHistorialBody = document.getElementById('tabla-historial-body');
            const btnRefreshHistorial = document.getElementById('btn-refresh-historial');

            const renderHistorial = async () => {
                if (!tablaHistorialBody) return;

                tablaHistorialBody.innerHTML = '<tr><td colspan="6" class="text-center py-4"><i data-lucide="loader" class="w-6 h-6 animate-spin mx-auto"></i></td></tr>';
                lucide.createIcons();

                try {
                    const response = await fetch('/api/historial');
                    const historial = await response.json();

                    tablaHistorialBody.innerHTML = '';

                    if (!historial || historial.length === 0) {
                        tablaHistorialBody.innerHTML = '<tr><td colspan="6" class="text-center text-gray-500 py-4">No hay nóminas guardadas.</td></tr>';
                        return;
                    }

                    historial.forEach(item => {
                        const tr = document.createElement('tr');

                        // Parseamos fecha creación
                        const fechaCreacion = new Date(item.fecha_creacion).toLocaleDateString() + ' ' + new Date(item.fecha_creacion).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

                        // Intentamos extraer datos del JSONB
                        let nombreEmpleado = item.empleado_id; // Fallback
                        let periodoTexto = `${item.mes}/${item.anio}`;
                        let devengado = parseFloat(item.total_devengado || 0).toFixed(2);
                        let liquido = parseFloat(item.liquido_percibir || 0).toFixed(2);

                        // Si tenemos el JSON completo, sacamos nombres más bonitos
                        if (item.datos_completo) {
                            if (item.datos_completo.empleado) nombreEmpleado = item.datos_completo.empleado.nombre;
                            if (item.datos_completo.periodo) periodoTexto = `${item.datos_completo.periodo.inicio} - ${item.datos_completo.periodo.fin}`;
                        } else if (item.empleado_nombre) {
                            // Compatibilidad con esquema antiguo si quedara data
                            nombreEmpleado = item.empleado_nombre;
                        }

                        tr.innerHTML = `
                            <td>${fechaCreacion}</td>
                            <td>${nombreEmpleado}</td>
                            <td>${periodoTexto}</td>
                            <td>${devengado} €</td>
                            <td class="font-bold text-green-400">${liquido} €</td>
                            <td>
                                <button class="btn btn-secondary text-xs py-1 px-2 btn-ver-historial" data-id="${item.id}">
                                    <i data-lucide="eye" class="w-4 h-4 mr-1"></i> Ver/Imprimir
                                </button>
                            </td>
                        `;

                        // Guardamos el objeto completo en el DOM element para acceso rápido
                        tr.querySelector('.btn-ver-historial').dataset.fullJson = JSON.stringify(item.datos_completo);

                        tablaHistorialBody.appendChild(tr);
                    });
                    lucide.createIcons();

                } catch (error) {
                    console.error("Error historial:", error);
                    tablaHistorialBody.innerHTML = '<tr><td colspan="6" class="text-center text-red-500 py-4">Error cargando historial.</td></tr>';
                }
            };

            if (btnRefreshHistorial) {
                btnRefreshHistorial.addEventListener('click', renderHistorial);
            }

            // Delegación de eventos para botones "Ver/Imprimir" del historial
            if (tablaHistorialBody) {
                tablaHistorialBody.addEventListener('click', (e) => {
                    const btn = e.target.closest('.btn-ver-historial');
                    if (btn) {
                        try {
                            const rawData = btn.dataset.fullJson;
                            if (!rawData || rawData === 'null') {
                                alert("Esta nómina no tiene datos detallados guardados (formato antiguo).");
                                return;
                            }

                            const data = JSON.parse(rawData);

                            // Reusamos la vista de "Generar Nómina"
                            // 1. Navegamos a la pestaña
                            showPage('nominas');

                            // 2. Establecemos variable global
                            ultimaNominaCalculada = {
                                nomina: data.nomina,
                                empleado: data.empleado,
                                periodo: data.periodo,
                                esHistorial: true // Flag importante
                            };

                            // 3. Renderizamos el resultado
                            displayNominaResult(data.nomina, data.empleado);

                            // 4. Inyectamos indicador visual de MODO HISTÓRICO
                            const container = document.getElementById('nomina-resultado');
                            if (container) {
                                const banner = document.createElement('div');
                                banner.className = 'bg-yellow-900 border-l-4 border-yellow-500 text-yellow-100 p-4 mb-4 rounded';
                                banner.innerHTML = `
                                    <div class="flex items-center">
                                        <i data-lucide="archive" class="w-6 h-6 mr-3"></i>
                                        <div>
                                            <p class="font-bold">Vista de Historial</p>
                                            <p class="text-sm">Estás viendo una copia guardada. No es un cálculo en tiempo real.</p>
                                        </div>
                                    </div>
                                `;
                                container.prepend(banner);
                                lucide.createIcons();
                            }

                            // 5. Ocultamos botón de guardar BD (ya está guardada)
                            if (btnGuardarIndividualBd) btnGuardarIndividualBd.style.display = 'none';

                        } catch (err) {
                            console.error(err);
                            alert("Error al abrir la nómina histórica.");
                        }
                    }
                });
            }

            // --- Lógica del Modal de Detalle de Nómina ---
            const nominaDetailModalOverlay = document.getElementById('nomina-detail-modal-overlay');
            const nominaDetailModalTitle = document.getElementById('nomina-detail-modal-title');
            const nominaDetailModalContent = document.getElementById('nomina-detail-modal-content');
            const closeNominaDetailModalBtn = document.getElementById('close-nomina-detail-modal');
            const btnCloseDetailModal = document.getElementById('btn-close-detail-modal');

            const closeDetailModal = () => {
                nominaDetailModalOverlay.classList.add('hidden');
            };

            closeNominaDetailModalBtn?.addEventListener('click', closeDetailModal);
            btnCloseDetailModal?.addEventListener('click', closeDetailModal);

            // Delegación para el botón "Ver Detalle"
            nominaLoteResultadoDiv?.addEventListener('click', (e) => {
                const btn = e.target.closest('.btn-ver-detalle-lote');
                if (btn) {
                    const index = btn.dataset.index;
                    const result = ultimoCalculo[index];
                    if (result) {
                        showNominaDetailInModal(result.nomina, result.empleado);
                    }
                }
            });

            const showNominaDetailInModal = (nomina, empleado) => {
                if (nominaDetailModalTitle) {
                    nominaDetailModalTitle.textContent = `Detalle de Nómina: ${empleado.nombre}`;
                }

                let otrosDevengosHtml = '';
                if (nomina.otrosDevengos && nomina.otrosDevengos.length > 0) {
                    nomina.otrosDevengos.forEach(d => {
                        if (parseFloat(d.importe) > 0) {
                            otrosDevengosHtml += `<dt>${d.concepto || 'Otro Devengo'}</dt><dd>${d.importe} €</dd>`;
                        }
                    });
                }

                let conceptosCalculadosHtml = '';
                if (nomina.conceptosCalculados && nomina.conceptosCalculados.length > 0) {
                    conceptosCalculadosHtml = nomina.conceptosCalculados.map(c =>
                        `<dt>${c.nombre || c.concepto} ${c.periodos ? `(${c.periodos})` : ''}</dt><dd>${c.importe} €</dd>`
                    ).join('');
                }

                let otrasDeduccionesHtml = '';
                if (nomina.otrasDeducciones && nomina.otrasDeducciones.length > 0) {
                    nomina.otrasDeducciones.forEach(d => {
                        if (parseFloat(d.importe) > 0) {
                            otrasDeduccionesHtml += `<dt>&nbsp;&nbsp;&nbsp;${d.concepto || 'Otra Deducción'}</dt><dd>${d.importe} €</dd>`;
                        }
                    });
                }

                nominaDetailModalContent.innerHTML = `
            <div class="space-y-6">
                <div>
                    <h4 class="font-semibold text-blue-400 mb-2 border-b border-gray-600 pb-1">I. DEVENGOS</h4>
                    <dl class="nomina-result-grid">
                        <dt>Salario Base (${nomina.diasTrabajados} días)</dt><dd>${nomina.salarioBasePeriodo} €</dd>
                        <dt>Prorrata Pagas Extra</dt><dd>${nomina.prorrataExtraPeriodo} €</dd>
                        
                        ${conceptosCalculadosHtml}

                        ${otrosDevengosHtml}
                        ${nomina.complementoEnfermedadEmpresa > 0 ? `<dt>Complemento Empresa por Baja</dt><dd>${nomina.complementoEnfermedadEmpresa} €</dd>` : ''}
                        ${nomina.diasBajaEnPeriodo > 0 ? `<dt>Prestación por Baja (${nomina.diasBajaEnPeriodo} días)</dt><dd>${nomina.prestacionEnfermedadLegal} €</dd>` : ''}
                        <dt class="border-t border-gray-600 pt-2 mt-2 font-bold text-gray-200">A. TOTAL DEVENGADO</dt>
                        <dd class="border-t border-gray-600 pt-2 mt-2 font-bold text-gray-200">${nomina.totalDevengos} €</dd>
                    </dl>
                </div>
                <div>
                    <h4 class="font-semibold text-blue-400 mb-2 border-b border-gray-600 pb-1">II. DEDUCCIONES</h4>
                    <dl class="nomina-result-grid">
                        <dt>Base de Cotización</dt><dd>${nomina.baseCotizacion} €</dd>
                        <dt class="col-span-2 text-gray-400 text-sm pt-2">Aportaciones del trabajador a la S.S.</dt>
                        <dt>&nbsp;&nbsp;&nbsp;Contingencias Comunes (${nomina.porcCC}%)</dt><dd>${nomina.deduccionCC} €</dd>
                        <dt>&nbsp;&nbsp;&nbsp;Desempleo (${nomina.porcDesempleo}%)</dt><dd>${nomina.deduccionDesempleo} €</dd>
                        <dt>&nbsp;&nbsp;&nbsp;Formación Profesional (${nomina.porcFP}%)</dt><dd>${nomina.deduccionFP} €</dd>
                        <dt>&nbsp;&nbsp;&nbsp;MEI (${nomina.porcMEI}%)</dt><dd>${nomina.deduccionMEI} €</dd>
                        <dt class="col-span-2 text-gray-400 text-sm pt-2">Otras Deducciones</dt>
                        <dt>&nbsp;&nbsp;&nbsp;IRPF (${nomina.porcentajeIRPF}%)</dt><dd>${nomina.deduccionIRPF} €</dd>
                        ${otrasDeduccionesHtml}
                        <dt class="border-t border-gray-600 pt-2 mt-2 font-bold text-gray-200">B. TOTAL A DEDUCIR</dt>
                        <dd class="border-t border-gray-600 pt-2 mt-2 font-bold text-gray-200">${nomina.totalDeducciones} €</dd>
                    </dl>
                </div>
                <div class="border-t-2 border-blue-400 pt-4">
                    <dl class="nomina-result-grid text-lg">
                        <dt class="font-bold text-gray-200">LÍQUIDO TOTAL A PERCIBIR (A-B)</dt>
                        <dd class="font-bold text-green-400">${nomina.salarioNeto} €</dd>
                    </dl>
                </div>
            </div>
        `;
                nominaDetailModalOverlay.classList.remove('hidden');
            };

            // --- Función para Exportar Lote a CSV ---
            const exportarLoteCSV = () => {
                if (!ultimoCalculo || !Array.isArray(ultimoCalculo) || ultimoCalculo.length === 0) {
                    showModal({ title: "Error", message: "No hay datos de lote para exportar." });
                    return;
                }

                // --- 1. Crear Cabeceras (Empleados) ---
                const headers = ['Concepto'];
                ultimoCalculo.forEach(res => {
                    headers.push(res.empleado.nombre);
                });

                // --- 2. Definir los Conceptos Fijos (en orden) ---
                const conceptosOrdenados = [
                    // Devengos Fijos
                    { key: 'salarioBasePeriodo', label: 'Salario Base' },
                    { key: 'prorrataExtraPeriodo', label: 'Prorrata Pagas Extra' },
                    // Marcador para antigüedad
                    { type: 'dynamic', category: 'antiguedad', labelPrefix: '' },
                    // Marcador para otros devengos
                    { type: 'dynamic', category: 'otrosDevengos', labelPrefix: '' },
                    { key: 'complementoEnfermedadEmpresa', label: 'Complemento Baja' },
                    { key: 'prestacionEnfermedadLegal', label: 'Prestación Baja' },
                    { key: 'totalDevengos', label: 'TOTAL DEVENGADO' },
                    // Separador Visual (Opcional)
                    { type: 'separator' },
                    // Deducciones Fijas
                    { key: 'baseCotizacion', label: 'Base Cotización' },
                    { key: 'deduccionCC', label: 'Deducción CC' },
                    { key: 'deduccionDesempleo', label: 'Deducción Desempleo' },
                    { key: 'deduccionFP', label: 'Deducción FP' },
                    { key: 'deduccionMEI', label: 'Deducción MEI' },
                    { key: 'totalDeduccionesSS', label: 'Total Aportaciones S.S.' },
                    { key: 'deduccionIRPF', label: 'Deducción IRPF' },
                    // Marcador para otras deducciones
                    { type: 'dynamic', category: 'otrasDeducciones', labelPrefix: 'Deducción: ' },
                    { key: 'totalDeducciones', label: 'TOTAL DEDUCIDO' },
                    // Separador Visual (Opcional)
                    { type: 'separator' },
                    // Neto
                    { key: 'salarioNeto', label: 'LÍQUIDO A PERCIBIR' },
                    // Separador Visual (Opcional)
                    { type: 'separator' },
                    // Aportaciones Empresa
                    { key: 'aportacionEmpresaCC', label: 'Aport. Empresa CC' },
                    { key: 'aportacionEmpresaATEP', label: 'Aport. Empresa AT y EP' },
                    { key: 'aportacionEmpresaDesempleo', label: 'Aport. Empresa Desempleo' },
                    { key: 'aportacionEmpresaFP', label: 'Aport. Empresa FP' },
                    { key: 'aportacionEmpresaFogasa', label: 'Aport. Empresa FOGASA' },
                    { key: 'totalAportacionesEmpresa', label: 'Total Aport. Empresa' },
                    { key: 'totalCoste', label: 'Coste Total Empresa' },
                ];

                // --- 3. Recopilar TODOS los conceptos dinámicos únicos y sus valores por empleado ---
                const dynamicConceptsData = {}; // { 'Concept Name': ['val1', 'val2', ...], ... }

                ultimoCalculo.forEach((res, employeeIndex) => {
                    if (res.nomina && !res.nomina.error) {
                        // Conceptos de Antigüedad
                        (res.nomina.conceptosCalculados || []).forEach(c => {
                            const conceptName = `${c.nombre}`;
                            if (!dynamicConceptsData[conceptName]) {
                                dynamicConceptsData[conceptName] = Array(ultimoCalculo.length).fill('0,00');
                            }
                            dynamicConceptsData[conceptName][employeeIndex] = c.importe || '0,00';
                        });
                        // Otros Devengos Comunes
                        (res.nomina.otrosDevengos || []).filter(d => parseFloat(d.importe) > 0).forEach(d => {
                            const conceptName = d.concepto;
                            if (!dynamicConceptsData[conceptName]) {
                                dynamicConceptsData[conceptName] = Array(ultimoCalculo.length).fill('0,00');
                            }
                            dynamicConceptsData[conceptName][employeeIndex] = d.importe || '0,00';
                        });
                        // Otras Deducciones Comunes
                        (res.nomina.otrasDeducciones || []).filter(d => parseFloat(d.importe) > 0).forEach(d => {
                            const conceptName = `Deducción: ${d.concepto}`; // Usamos el prefijo como clave única
                            if (!dynamicConceptsData[conceptName]) {
                                dynamicConceptsData[conceptName] = Array(ultimoCalculo.length).fill('0,00');
                            }
                            dynamicConceptsData[conceptName][employeeIndex] = d.importe || '0,00';
                        });
                    } else {
                        // Si hay error, necesitamos llenar placeholders en dynamicConceptsData
                        Object.keys(dynamicConceptsData).forEach(conceptName => {
                            if (!dynamicConceptsData[conceptName][employeeIndex]) { // Si no se llenó aún
                                dynamicConceptsData[conceptName][employeeIndex] = 'ERROR';
                            }
                        });
                    }
                });

                // Obtenemos las listas de nombres únicos para cada categoría dinámica
                const nombresAntiguedad = Object.keys(dynamicConceptsData).filter(name => /.*\(\d+\)$/.test(name));
                const nombresOtrosDevengos = Object.keys(dynamicConceptsData).filter(name => !/.*\(\d+\)$/.test(name) && !name.startsWith('Deducción: '));
                const nombresOtrasDeducciones = Object.keys(dynamicConceptsData).filter(name => name.startsWith('Deducción: '));


                // --- 4. Construir las Filas de Datos en Orden ---
                const rows = [];
                conceptosOrdenados.forEach(concepto => {
                    if (concepto.type === 'separator') {
                        rows.push(Array(headers.length).fill('')); // Fila vacía como separador
                    } else if (concepto.type === 'dynamic') {
                        // Insertar aquí las filas de conceptos dinámicos correspondientes
                        let dynamicNames;
                        if (concepto.category === 'antiguedad') dynamicNames = nombresAntiguedad;
                        else if (concepto.category === 'otrosDevengos') dynamicNames = nombresOtrosDevengos;
                        else if (concepto.category === 'otrasDeducciones') dynamicNames = nombresOtrasDeducciones;

                        (dynamicNames || []).forEach(name => {
                            // Usamos el prefijo definido si existe
                            rows.push([`${concepto.labelPrefix || ''}${name}`, ...(dynamicConceptsData[name] || Array(ultimoCalculo.length).fill('0,00'))]);
                        });
                    } else {
                        // Es un concepto fijo
                        const row = [concepto.label];
                        ultimoCalculo.forEach(res => {
                            row.push(res.nomina.error ? 'ERROR' : (res.nomina[concepto.key] ?? '0,00'));
                        });
                        rows.push(row);
                    }
                });

                // --- 5. Generar el Contenido CSV y Descargar (Sin cambios) ---
                let csvContent = headers.join(';') + '\n';
                rows.forEach(rowArray => {
                    let processedRow = rowArray.map(item => `"${String(item ?? '').replace(/\./g, ',')}"`);
                    csvContent += processedRow.join(';') + '\n';
                });
                const blob = new Blob(['\uFEFF' + csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement("a");
                const url = URL.createObjectURL(blob);
                link.setAttribute("href", url);
                const fechaInicioPeriodo = new Date(ultimoCalculo[0].periodo?.inicio + 'T00:00:00');
                const mesNomina = fechaInicioPeriodo.toLocaleString('es-ES', { month: 'long' });
                const anioNomina = fechaInicioPeriodo.getFullYear();
                const fileName = `Nominas_${mesNomina}_${anioNomina}.csv`;
                link.setAttribute("download", fileName);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            };

            // Listener para el botón de exportar lote CSV
            btnExportarLoteCsv?.addEventListener('click', exportarLoteCSV);

            // ==========================================================
            // --- LÓGICA DE EXPORTACIÓN A CSV ---
            // ==========================================================
            const exportarNominaCSV = () => {
                if (!ultimaNominaCalculada) {
                    showModal({ title: "Error", message: "No hay datos de nómina para exportar." });
                    return;
                }

                const { nomina, empleado, periodo } = ultimaNominaCalculada;

                const headers = ['Concepto', 'Valor'];
                let rows = [
                    ['Empleado', empleado.nombre],
                    ['DNI', empleado.dni],
                    ['Periodo', `${periodo.inicio} al ${periodo.fin}`],
                    [],
                    ['--- DEVENGOS ---', ''],
                    ['Salario Base', nomina.salarioBasePeriodo],
                    ['Prorrata Pagas Extra', nomina.prorrataExtraPeriodo],
                    ['CPP', nomina.cppPeriodo],
                ];

                if (nomina.otrosDevengos && nomina.otrosDevengos.length > 0) {
                    nomina.otrosDevengos.forEach(d => {
                        if (parseFloat(d.importe) > 0) {
                            rows.push([d.concepto || 'Otro Devengo', d.importe]);
                        }
                    });
                }

                rows.push(
                    ['Complemento Baja', nomina.complementoEnfermedadEmpresa],
                    ['Prestación Baja', nomina.prestacionEnfermedadLegal],
                    ['TOTAL DEVENGADO', nomina.totalDevengos],
                    [],
                    ['--- DEDUCCIONES ---', '']
                );

                // --- SECCIÓN MODIFICADA ---
                // En lugar de una sola línea, ahora desglosamos las cotizaciones de la S.S.
                rows.push(
                    [`Deducción S.S.: Contingencias Comunes (${nomina.porcCC}%)`, nomina.deduccionCC],
                    [`Deducción S.S.: Desempleo (${nomina.porcDesempleo}%)`, nomina.deduccionDesempleo],
                    [`Deducción S.S.: Formación Profesional (${nomina.porcFP}%)`, nomina.deduccionFP],
                    [`Deducción S.S.: MEI (${nomina.porcMEI}%)`, nomina.deduccionMEI],
                    ['Total Aportaciones S.S.', nomina.totalDeduccionesSS],
                    ['IRPF', nomina.deduccionIRPF]
                );
                // --- FIN DE LA SECCIÓN MODIFICADA ---

                if (nomina.otrasDeducciones && nomina.otrasDeducciones.length > 0) {
                    nomina.otrasDeducciones.forEach(d => {
                        if (parseFloat(d.importe) > 0) {
                            rows.push([d.concepto || 'Otra Deducción', d.importe]);
                        }
                    });
                }

                rows.push(
                    ['TOTAL DEDUCIDO', nomina.totalDeducciones],
                    [],
                    ['--- LÍQUIDO A PERCIBIR ---', ''],
                    ['SALARIO NETO', nomina.salarioNeto]
                );

                // El delimitador se cambia a punto y coma (;) para mayor compatibilidad con Excel en español
                let csvContent = headers.join(';') + '\n';
                rows.forEach(rowArray => {
                    // Reemplazamos el punto del decimal por una coma
                    let processedRow = rowArray.map(item => `"${String(item).replace(/\./g, ',')}"`);
                    csvContent += processedRow.join(';') + '\n';
                });

                const blob = new Blob(['\uFEFF' + csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement("a");
                const url = URL.createObjectURL(blob);
                link.setAttribute("href", url);
                const fileName = `nomina_${empleado.nombre.replace(/\s+/g, '_')}_${periodo.inicio}_${periodo.fin}.csv`;
                link.setAttribute("download", fileName);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            };

            document.getElementById('btn-exportar-nomina').addEventListener('click', exportarNominaCSV);
            document.getElementById('btn-exportar-pdf').addEventListener('click', () => {
                if (ultimaNominaCalculada) {
                    // Añadimos el objeto 'puesto' que necesita la función del PDF
                    const datosCompletos = {
                        ...ultimaNominaCalculada,
                        puesto: puestos.find(p => p.id === ultimaNominaCalculada.empleado.puestoId),
                        empresa: empresa
                    };
                    generarPdfNomina(datosCompletos);
                } else {
                    showModal({ title: "Error", message: "No hay datos de nómina para generar el PDF." });
                }
            });

            document.getElementById('btn-exportar-lote-pdf')?.addEventListener('click', () => {
                if (ultimoCalculo && Array.isArray(ultimoCalculo)) {
                    // Pasamos la lista de resultados, los datos de la empresa y la lista completa de puestos
                    generarPdfLote(ultimoCalculo, empresa, puestos);
                } else {
                    showModal({ title: "Error", message: "No hay datos de lote para generar el PDF." });
                }
            });

            // --- LISTENERS DE GUARDADO EN BASE DE DATOS ---

            // 1. Guardado Individual
            if (btnGuardarIndividualBd) {
                btnGuardarIndividualBd.addEventListener('click', async () => {
                    if (!ultimaNominaCalculada) return;

                    // Parseamos la fecha de inicio (formato YYYY-MM-DD)
                    const fechaObj = new Date(ultimaNominaCalculada.periodo.inicio);

                    // Corregimos los datos antes de enviarlos
                    ultimaNominaCalculada.mes = fechaObj.getMonth() + 1; // getMonth() devuelve 0-11, sumamos 1
                    ultimaNominaCalculada.anio = fechaObj.getFullYear();

                    // Validación de seguridad por si la fecha es inválida
                    if (isNaN(ultimaNominaCalculada.mes) || isNaN(ultimaNominaCalculada.anio)) {
                        showModal({ title: "Error", message: "La fecha de la nómina no es válida. Revisa las fechas de inicio." });
                        return;
                    }

                    const originalText = btnGuardarIndividualBd.innerHTML;
                    btnGuardarIndividualBd.innerHTML = '<i data-lucide="loader" class="w-4 h-4 mr-2 animate-spin"></i> Guardando...';
                    btnGuardarIndividualBd.disabled = true;

                    try {
                        const response = await fetch('/api/guardar', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(ultimaNominaCalculada)
                        });
                        const result = await response.json();

                        if (result.success) {
                            showModal({ title: "Éxito", message: "Nómina guardada en la base de datos correctamente." });
                        } else {
                            throw new Error(result.error);
                        }
                    } catch (error) {
                        console.error(error);
                        showModal({ title: "Error", message: "Error al guardar la nómina: " + error.message });
                    } finally {
                        btnGuardarIndividualBd.innerHTML = originalText;
                        btnGuardarIndividualBd.disabled = false;
                        lucide.createIcons();
                    }
                });
            }

            // 2. Guardado Lote
            if (btnGuardarLoteBd) {
                btnGuardarLoteBd.addEventListener('click', async () => {
                    if (!ultimoCalculo || !Array.isArray(ultimoCalculo) || ultimoCalculo.length === 0) {
                        showModal({ title: "Error", message: "No hay nóminas calculadas para guardar." });
                        return;
                    }

                    const originalText = btnGuardarLoteBd.innerHTML;
                    btnGuardarLoteBd.disabled = true;
                    btnGuardarLoteBd.innerHTML = `<i data-lucide="loader" class="w-4 h-4 mr-2 animate-spin"></i> Procesando...`;

                    let guardados = 0;
                    let errores = 0;

                    for (let i = 0; i < ultimoCalculo.length; i++) {
                        const item = ultimoCalculo[i];

                        // 1. VERIFICACIÓN DE SEGURIDAD "NaN"
                        // Si el total devengado es "NaN" (string), el cálculo falló por fechas inválidas.
                        if (item.nomina.totalDevengos === "NaN" || isNaN(parseFloat(item.nomina.totalDevengos))) {
                            console.error(`Omitiendo ${item.empleado.nombre}: Cálculo inválido (NaN). Revisa fechas.`);
                            errores++;
                            continue;
                        }

                        // 2. CALCULAR MES Y AÑO SEGURO
                        const fechaObj = new Date(item.periodo.inicio);
                        // Validar que la fecha sea real
                        if (isNaN(fechaObj.getTime())) {
                            errores++;
                            continue;
                        }
                        
                        const mesCalculado = fechaObj.getMonth() + 1;
                        const anioCalculado = fechaObj.getFullYear();

                        // UI Feedback
                        btnGuardarLoteBd.innerHTML = `<i data-lucide="loader" class="w-4 h-4 mr-2 animate-spin"></i> Guardando ${i + 1}/${ultimoCalculo.length}...`;

                        try {
                            const payload = {
                                empleado: item.empleado,
                                periodo: item.periodo,
                                nomina: item.nomina, // Aquí van los importes
                                mes: mesCalculado,   
                                anio: anioCalculado
                            };

                            const response = await fetch('/api/guardar', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify(payload)
                            });
                            
                            const result = await response.json();
                            if (result.success) guardados++;
                            else errores++;

                        } catch (error) {
                            console.error(error);
                            errores++;
                        }
                    }

                    btnGuardarLoteBd.innerHTML = originalText;
                    btnGuardarLoteBd.disabled = false;
                    if (typeof lucide !== 'undefined') lucide.createIcons();

                    showModal({
                        title: "Proceso Finalizado",
                        message: `Guardado completado.\n✅ Correctos: ${guardados}\n❌ Errores/Omitidos: ${errores}\n\nNota: Si hubo errores, revisa que las fechas de inicio/fin sean válidas.`
                    });
                });
            }


            // ==========================================================
            // --- INICIALIZACIÓN DE LA APP ---
            // ==========================================================
            function init() {
                // 1. Lógica de Pantalla de Carga (Se mantiene igual)
                setTimeout(() => {
                    const loadingScreen = document.getElementById('loading-screen');
                    const appContainer = document.getElementById('app-container');

                    // Inicia el desvanecimiento
                    loadingScreen.style.opacity = '0';

                    loadingScreen.addEventListener('transitionend', () => {
                        loadingScreen.style.display = 'none';
                    });

                    appContainer.classList.remove('hidden');

                    // Navegación a la última página visitada
                    const activePage = localStorage.getItem('activePage') || 'home-page';
                    showPage(activePage);

                }, 3500);

                // 2. Cargar Configuración Local (SS, Empresa, etc. siguen en local por ahora)
                loadConfigSS();

                // 3. CARGA DE DATOS DE LA BASE DE DATOS
                // IMPORTANTE: Ya no llamamos a renderPuestos() aquí manualmente.
                // La función loadDataFromDB() se encarga de descargar Y renderizar.
                loadDataFromDB();

                navLinks.forEach(link => {
                    link.addEventListener('click', (e) => {
                        e.preventDefault();
                        const targetId = e.currentTarget.dataset.target;
                        showPage(targetId);
                    });
                });

            } // <--- Cierre de la función init()

            // Arrancamos la aplicación
            init();

        }); // <--- Cierre del DOMContentLoaded
    </script>
</body>

</html>